{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 34, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/HEALO_Demo/src/lib/rag/supabaseAdmin.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\";\n\nconst supabaseUrl =\n  process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.VITE_SUPABASE_URL;\nconst serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\nif (!supabaseUrl || !serviceKey) {\n  const missing = [];\n  if (!supabaseUrl) missing.push(\"NEXT_PUBLIC_SUPABASE_URL/VITE_SUPABASE_URL\");\n  if (!serviceKey) missing.push(\"SUPABASE_SERVICE_ROLE_KEY\");\n  throw new Error(`Supabase admin env missing: ${missing.join(\", \")}`);\n}\n\nexport const supabaseAdmin = createClient(supabaseUrl, serviceKey, {\n  auth: { persistSession: false },\n});\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,cACJ,gFAAwC,QAAQ,GAAG,CAAC,iBAAiB;AACvE,MAAM,aAAa,QAAQ,GAAG,CAAC,yBAAyB;AAExD,IAAI,CAAC,eAAe,CAAC,YAAY;IAC/B,MAAM,UAAU,EAAE;IAClB;;IACA,IAAI,CAAC,YAAY,QAAQ,IAAI,CAAC;IAC9B,MAAM,IAAI,MAAM,CAAC,4BAA4B,EAAE,QAAQ,IAAI,CAAC,OAAO;AACrE;AAEO,MAAM,gBAAgB,IAAA,gMAAY,EAAC,aAAa,YAAY;IACjE,MAAM;QAAE,gBAAgB;IAAM;AAChC"}},
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/HEALO_Demo/app/api/rag/search/route.ts"],"sourcesContent":["import { supabaseAdmin } from \"../../../../src/lib/rag/supabaseAdmin\";\n\nexport async function POST(request: Request) {\n  try {\n    const body = await request.json();\n    const query = String(body?.query || \"\").trim();\n    const limit = Number(body?.limit || 10);\n    const lang = body?.lang ? String(body.lang) : null;\n    const sourceTypes = Array.isArray(body?.sourceTypes)\n      ? body.sourceTypes\n      : null;\n\n    if (!query) {\n      return Response.json(\n        { ok: false, error: \"query_required\" },\n        { status: 400 }\n      );\n    }\n\n    const tokens = query\n      .toLowerCase()\n      .replace(/[^a-z0-9가-힣\\s]/gi, \" \")\n      .split(/\\s+/)\n      .filter(Boolean)\n      .filter((t) => t.length >= 3)\n      .slice(0, 6);\n\n    const terms = tokens.length ? tokens : [query];\n    const orFilter = terms.map((t) => `content.ilike.%${t}%`).join(\",\");\n\n    let q = supabaseAdmin\n      .from(\"rag_chunks\")\n      .select(\n        \"id, document_id, chunk_index, content, metadata, rag_documents(id, source_type, source_id, lang, title)\"\n      )\n      .or(orFilter)\n      .limit(30);\n\n    if (lang) q = q.eq(\"rag_documents.lang\", lang);\n    if (sourceTypes?.length)\n      q = q.in(\"rag_documents.source_type\", sourceTypes);\n\n    const { data, error } = await q;\n    if (error) throw error;\n\n    const results = (data || []).map((row) => {\n      const content = String(row.content || \"\").toLowerCase();\n      const score = terms.reduce(\n        (sum, t) => (content.includes(t.toLowerCase()) ? sum + 1 : sum),\n        0\n      );\n      return { ...row, _score: score };\n    });\n\n    results.sort((a, b) => b._score - a._score);\n\n    return Response.json({\n      ok: true,\n      results: results.slice(0, limit),\n      scoring: \"token match count over up to 6 tokens\",\n    });\n  } catch (error: any) {\n    return Response.json(\n      { ok: false, error: error?.message || \"search_failed\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEO,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI;QAC/B,MAAM,QAAQ,OAAO,MAAM,SAAS,IAAI,IAAI;QAC5C,MAAM,QAAQ,OAAO,MAAM,SAAS;QACpC,MAAM,OAAO,MAAM,OAAO,OAAO,KAAK,IAAI,IAAI;QAC9C,MAAM,cAAc,MAAM,OAAO,CAAC,MAAM,eACpC,KAAK,WAAW,GAChB;QAEJ,IAAI,CAAC,OAAO;YACV,OAAO,SAAS,IAAI,CAClB;gBAAE,IAAI;gBAAO,OAAO;YAAiB,GACrC;gBAAE,QAAQ;YAAI;QAElB;QAEA,MAAM,SAAS,MACZ,WAAW,GACX,OAAO,CAAC,oBAAoB,KAC5B,KAAK,CAAC,OACN,MAAM,CAAC,SACP,MAAM,CAAC,CAAC,IAAM,EAAE,MAAM,IAAI,GAC1B,KAAK,CAAC,GAAG;QAEZ,MAAM,QAAQ,OAAO,MAAM,GAAG,SAAS;YAAC;SAAM;QAC9C,MAAM,WAAW,MAAM,GAAG,CAAC,CAAC,IAAM,CAAC,eAAe,EAAE,EAAE,CAAC,CAAC,EAAE,IAAI,CAAC;QAE/D,IAAI,IAAI,qJAAa,CAClB,IAAI,CAAC,cACL,MAAM,CACL,2GAED,EAAE,CAAC,UACH,KAAK,CAAC;QAET,IAAI,MAAM,IAAI,EAAE,EAAE,CAAC,sBAAsB;QACzC,IAAI,aAAa,QACf,IAAI,EAAE,EAAE,CAAC,6BAA6B;QAExC,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM;QAC9B,IAAI,OAAO,MAAM;QAEjB,MAAM,UAAU,CAAC,QAAQ,EAAE,EAAE,GAAG,CAAC,CAAC;YAChC,MAAM,UAAU,OAAO,IAAI,OAAO,IAAI,IAAI,WAAW;YACrD,MAAM,QAAQ,MAAM,MAAM,CACxB,CAAC,KAAK,IAAO,QAAQ,QAAQ,CAAC,EAAE,WAAW,MAAM,MAAM,IAAI,KAC3D;YAEF,OAAO;gBAAE,GAAG,GAAG;gBAAE,QAAQ;YAAM;QACjC;QAEA,QAAQ,IAAI,CAAC,CAAC,GAAG,IAAM,EAAE,MAAM,GAAG,EAAE,MAAM;QAE1C,OAAO,SAAS,IAAI,CAAC;YACnB,IAAI;YACJ,SAAS,QAAQ,KAAK,CAAC,GAAG;YAC1B,SAAS;QACX;IACF,EAAE,OAAO,OAAY;QACnB,OAAO,SAAS,IAAI,CAClB;YAAE,IAAI;YAAO,OAAO,OAAO,WAAW;QAAgB,GACtD;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}