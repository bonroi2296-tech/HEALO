{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/HEALO_Demo/src/lib/rag/supabaseAdmin.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\";\n\nconst supabaseUrl =\n  process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.VITE_SUPABASE_URL;\nconst serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\nif (!supabaseUrl || !serviceKey) {\n  const missing = [];\n  if (!supabaseUrl) missing.push(\"NEXT_PUBLIC_SUPABASE_URL/VITE_SUPABASE_URL\");\n  if (!serviceKey) missing.push(\"SUPABASE_SERVICE_ROLE_KEY\");\n  throw new Error(`Supabase admin env missing: ${missing.join(\", \")}`);\n}\n\nexport const supabaseAdmin = createClient(supabaseUrl, serviceKey, {\n  auth: { persistSession: false },\n});\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,cACJ,gFAAwC,QAAQ,GAAG,CAAC,iBAAiB;AACvE,MAAM,aAAa,QAAQ,GAAG,CAAC,yBAAyB;AAExD,IAAI,CAAC,eAAe,CAAC,YAAY;IAC/B,MAAM,UAAU,EAAE;IAClB;;IACA,IAAI,CAAC,YAAY,QAAQ,IAAI,CAAC;IAC9B,MAAM,IAAI,MAAM,CAAC,4BAA4B,EAAE,QAAQ,IAAI,CAAC,OAAO;AACrE;AAEO,MAAM,gBAAgB,IAAA,gMAAY,EAAC,aAAa,YAAY;IACjE,MAAM;QAAE,gBAAgB;IAAM;AAChC"}},
    {"offset": {"line": 64, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/HEALO_Demo/app/api/inquiry/normalize/route.ts"],"sourcesContent":["import { supabaseAdmin } from \"../../../../src/lib/rag/supabaseAdmin\";\n\nconst detectLanguage = (value: string | null | undefined) => {\n  const v = String(value || \"\").toLowerCase();\n  if (v.includes(\"ko\") || v.includes(\"kr\") || v.includes(\"korean\")) return \"ko\";\n  if (v.includes(\"ja\") || v.includes(\"jp\") || v.includes(\"japanese\")) return \"ja\";\n  return \"en\";\n};\n\nexport async function POST(request: Request) {\n  try {\n    const body = await request.json().catch(() => ({}));\n    const text = body?.text ? String(body.text) : \"\";\n    const inquiryId = body?.inquiry_id ? Number(body.inquiry_id) : null;\n\n    if (!text && !inquiryId) {\n      return Response.json(\n        { ok: false, error: \"text_or_inquiry_id_required\" },\n        { status: 400 }\n      );\n    }\n\n    let inquiryRow: any = null;\n    if (inquiryId) {\n      const { data, error } = await supabaseAdmin\n        .from(\"inquiries\")\n        .select(\n          \"id, first_name, last_name, email, nationality, spoken_language, contact_method, contact_id, treatment_type, message\"\n        )\n        .eq(\"id\", inquiryId)\n        .single();\n      if (error) throw error;\n      inquiryRow = data;\n    }\n\n    const rawMessage = text || inquiryRow?.message || null;\n    const language = detectLanguage(inquiryRow?.spoken_language);\n\n    const { data: inserted, error: insertError } = await supabaseAdmin\n      .from(\"normalized_inquiries\")\n      .insert({\n        source_type: inquiryRow ? \"inquiry_form\" : \"ai_agent\",\n        source_inquiry_id: inquiryRow ? inquiryRow.id : null,\n        language,\n        country: inquiryRow?.nationality || null,\n        treatment_slug: inquiryRow?.treatment_type || null,\n        objective: null,\n        constraints: {},\n        raw_message: rawMessage,\n        extraction_confidence: null,\n        missing_fields: null,\n        contact: inquiryRow\n          ? {\n              email: inquiryRow.email || null,\n              messenger_channel: inquiryRow.contact_method || null,\n              messenger_handle: inquiryRow.contact_id || null,\n            }\n          : null,\n      })\n      .select(\"*\")\n      .single();\n\n    if (insertError) throw insertError;\n\n    return Response.json({ ok: true, normalized: inserted });\n  } catch (error: any) {\n    return Response.json(\n      { ok: false, error: error?.message || \"normalize_failed\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,iBAAiB,CAAC;IACtB,MAAM,IAAI,OAAO,SAAS,IAAI,WAAW;IACzC,IAAI,EAAE,QAAQ,CAAC,SAAS,EAAE,QAAQ,CAAC,SAAS,EAAE,QAAQ,CAAC,WAAW,OAAO;IACzE,IAAI,EAAE,QAAQ,CAAC,SAAS,EAAE,QAAQ,CAAC,SAAS,EAAE,QAAQ,CAAC,aAAa,OAAO;IAC3E,OAAO;AACT;AAEO,eAAe,KAAK,OAAgB;IACzC,IAAI;QACF,MAAM,OAAO,MAAM,QAAQ,IAAI,GAAG,KAAK,CAAC,IAAM,CAAC,CAAC,CAAC;QACjD,MAAM,OAAO,MAAM,OAAO,OAAO,KAAK,IAAI,IAAI;QAC9C,MAAM,YAAY,MAAM,aAAa,OAAO,KAAK,UAAU,IAAI;QAE/D,IAAI,CAAC,QAAQ,CAAC,WAAW;YACvB,OAAO,SAAS,IAAI,CAClB;gBAAE,IAAI;gBAAO,OAAO;YAA8B,GAClD;gBAAE,QAAQ;YAAI;QAElB;QAEA,IAAI,aAAkB;QACtB,IAAI,WAAW;YACb,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,qJAAa,CACxC,IAAI,CAAC,aACL,MAAM,CACL,uHAED,EAAE,CAAC,MAAM,WACT,MAAM;YACT,IAAI,OAAO,MAAM;YACjB,aAAa;QACf;QAEA,MAAM,aAAa,QAAQ,YAAY,WAAW;QAClD,MAAM,WAAW,eAAe,YAAY;QAE5C,MAAM,EAAE,MAAM,QAAQ,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,qJAAa,CAC/D,IAAI,CAAC,wBACL,MAAM,CAAC;YACN,aAAa,aAAa,iBAAiB;YAC3C,mBAAmB,aAAa,WAAW,EAAE,GAAG;YAChD;YACA,SAAS,YAAY,eAAe;YACpC,gBAAgB,YAAY,kBAAkB;YAC9C,WAAW;YACX,aAAa,CAAC;YACd,aAAa;YACb,uBAAuB;YACvB,gBAAgB;YAChB,SAAS,aACL;gBACE,OAAO,WAAW,KAAK,IAAI;gBAC3B,mBAAmB,WAAW,cAAc,IAAI;gBAChD,kBAAkB,WAAW,UAAU,IAAI;YAC7C,IACA;QACN,GACC,MAAM,CAAC,KACP,MAAM;QAET,IAAI,aAAa,MAAM;QAEvB,OAAO,SAAS,IAAI,CAAC;YAAE,IAAI;YAAM,YAAY;QAAS;IACxD,EAAE,OAAO,OAAY;QACnB,OAAO,SAAS,IAAI,CAClB;YAAE,IAAI;YAAO,OAAO,OAAO,WAAW;QAAmB,GACzD;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}