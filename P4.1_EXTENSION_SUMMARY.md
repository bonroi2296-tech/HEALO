# P4.1 확장: DB 기반 알림 수신자 관리 완료 보고서

> 작성일: 2026-01-29  
> 기반: P4.1-1 (ENV 기반 알림)  
> 확장: DB 기반 + 관리자 UI

---

## ✅ 완료 항목

1. ✅ **DB 테이블 추가** - `admin_notification_recipients`
2. ✅ **수신자 조회 로직** - DB 우선 → ENV fallback
3. ✅ **알림 모듈 확장** - DB 기반으로 발송
4. ✅ **관리자 API** - CRUD (GET/POST/PATCH/DELETE)
5. ✅ **관리자 UI** - 간단한 관리 페이지
6. ✅ **운영 문서** - DB 기반 사용 가이드

---

## 🎯 핵심 개선

### Before (P4.1-1: ENV만)

```bash
# .env.local
ADMIN_PHONE_NUMBERS=+821012345678,+821087654321

# 변경하려면:
1. .env 파일 수정
2. 앱 재배포
3. 5-10분 소요
```

### After (P4.1 확장: DB 우선)

```
1. /admin/settings/notifications 접속
2. "+ 수신자 추가" 클릭
3. 정보 입력 → 저장
4. 즉시 반영 (다음 문의부터)
```

---

## 📊 우선순위 체계

```
문의 접수
    ↓
sendAdminNotification() 호출
    ↓
getActiveRecipients()
    ↓
1️⃣ DB 조회 (is_active=true)
   - 성공 → DB 수신자 사용 ✅
   - 실패/0건 → 2️⃣
    ↓
2️⃣ ENV fallback (ADMIN_PHONE_NUMBERS)
   - 있음 → ENV 수신자 사용 ✅
   - 없음 → 3️⃣
    ↓
3️⃣ 알림 건너뜀 (로그만 기록)
```

---

## 🗄️ DB 구조

### admin_notification_recipients 테이블

```sql
CREATE TABLE admin_notification_recipients (
  id UUID PRIMARY KEY,
  label TEXT NOT NULL,           -- 수신자 이름
  phone_e164 TEXT NOT NULL,      -- E.164 형식 전화번호
  channel TEXT DEFAULT 'sms',    -- sms/alimtalk/email
  is_active BOOLEAN DEFAULT true,-- 활성화 여부
  
  -- 통계
  last_sent_at TIMESTAMPTZ,
  sent_count INTEGER DEFAULT 0,
  failed_count INTEGER DEFAULT 0,
  
  -- 메타
  notes TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

---

## 🔧 주요 기능

### 1. 수신자 조회 (recipients.ts)

```typescript
// DB 우선, ENV fallback
const recipients = await getActiveRecipients();

// 결과 예시:
[
  {
    id: "uuid-123",
    label: "김주영",
    phone: "+821012345678",
    channel: "sms",
    source: "db"
  },
  {
    id: "uuid-456",
    label: "야간 당직",
    phone: "+821087654321",
    channel: "sms",
    source: "db"
  }
]
```

---

### 2. 알림 발송 (adminNotifier.ts 확장)

```typescript
// Before (ENV만)
const adminPhones = process.env.ADMIN_PHONE_NUMBERS?.split(",");

// After (DB 우선)
const recipients = await getActiveRecipients();

for (const recipient of recipients) {
  // 발송 시도
  const result = await sendSMS(recipient.phone, message);
  
  // 통계 업데이트 (DB만)
  await updateRecipientStats(recipient.id, result.success);
  
  // 이벤트 로깅
  await logNotificationEvent(inquiryId, "admin_notified", {
    recipient_source: recipient.source, // "db" or "env"
    masked_to: maskPhone(recipient.phone)
  });
}
```

---

### 3. 관리자 API

#### GET /api/admin/notification-recipients

```bash
# 요청
GET /api/admin/notification-recipients

# 응답
{
  "ok": true,
  "recipients": [
    {
      "id": "uuid-123",
      "label": "김주영",
      "phone_masked": "+82-**-****-5678",
      "channel": "sms",
      "is_active": true,
      "last_sent_at": "2026-01-29T14:30:00Z",
      "sent_count": 42,
      "failed_count": 2
    }
  ]
}
```

#### POST /api/admin/notification-recipients

```bash
# 요청
POST /api/admin/notification-recipients
{
  "label": "이철수",
  "phone": "+821011112222",
  "channel": "sms",
  "notes": "부 관리자"
}

# 응답
{
  "ok": true,
  "id": "uuid-789"
}
```

#### PATCH /api/admin/notification-recipients/[id]

```bash
# 비활성화
PATCH /api/admin/notification-recipients/uuid-123
{
  "is_active": false
}

# 이름 변경
PATCH /api/admin/notification-recipients/uuid-123
{
  "label": "김주영 (휴가)"
}
```

#### DELETE /api/admin/notification-recipients/[id]

```bash
# Soft delete (is_active=false)
DELETE /api/admin/notification-recipients/uuid-123

# 응답
{
  "ok": true
}
```

---

### 4. 관리자 UI

**경로**: `/admin/settings/notifications`

**기능**:
- ✅ 수신자 목록 표시
- ✅ 수신자 추가 폼
- ✅ 활성화/비활성화 토글
- ✅ 삭제 버튼
- ✅ 통계 표시 (발송/실패 수)
- ✅ ENV fallback 안내

**스크린샷 (텍스트)**:
```
┌─────────────────────────────────────────────────────────┐
│ 알림 수신자 관리                                          │
│ 문의 접수 시 알림을 받을 관리자를 설정합니다.               │
│                                                          │
│ [+ 수신자 추가]                                           │
│                                                          │
│ ┌──────────────────────────────────────────────────────┐ │
│ │ 이름    | 전화번호         | 채널 | 활성 | 발송 | 실패 │ │
│ │ 김주영  | +82-**-****-5678 | sms  | 활성 | 42   | 2   │ │
│ │ 야간당직| +82-**-****-4321 | sms  | 활성 | 38   | 0   │ │
│ │ 이철수  | +82-**-****-9999 | sms  |비활성| 15   | 1   │ │
│ └──────────────────────────────────────────────────────┘ │
│                                                          │
│ 💡 ENV Fallback                                          │
│ DB에 활성 수신자가 없으면 ENV로 자동 전환됩니다.            │
│ 현재 ENV: +821012345678                                  │
└─────────────────────────────────────────────────────────┘
```

---

## 🔒 보안 강화

### 전화번호 마스킹

```typescript
// 저장 (DB)
phone_e164: "+821012345678"  // 평문 (발송용)

// 표시 (UI/로그)
phone_masked: "+82-**-****-5678"  // 마스킹

// 함수
maskPhone("+821012345678")  // → "+82-**-****-5678"
```

### 로그 정책

```
✅ 올바름
[Notify] 발송 성공: recipient_source=db, masked_to=+82-**-****-5678

❌ 잘못됨
[Notify] 발송 성공: +821012345678  // 평문 노출
```

---

## 📈 통계 추적

### 수신자별 통계

```sql
SELECT 
  label,
  sent_count,
  failed_count,
  ROUND(sent_count * 100.0 / NULLIF(sent_count + failed_count, 0), 1) as success_rate
FROM admin_notification_recipients
WHERE is_active = true;
```

**결과**:
```
label      | sent_count | failed_count | success_rate
-----------|------------|--------------|-------------
김주영     | 42         | 2            | 95.5%
야간 당직  | 38         | 0            | 100.0%
```

### 이벤트 로그

```sql
SELECT 
  event_data->>'recipient_source' as source,
  COUNT(*) as count
FROM inquiry_events
WHERE event_type = 'admin_notified'
  AND created_at > NOW() - INTERVAL '7 days'
GROUP BY source;
```

**결과**:
```
source | count
-------|------
db     | 78
env    | 2
```
→ DB가 주로 사용됨, ENV는 백업으로만

---

## 💡 사용 시나리오

### 시나리오 1: 신규 관리자 온보딩

```
1. HR에서 신규 관리자 정보 수신
   - 이름: 박영희
   - 휴대폰: +821099998888

2. /admin/settings/notifications 접속
   
3. "+ 수신자 추가" 클릭
   - 이름: 박영희
   - 전화번호: +821099998888
   - 메모: 신규 입사 (2026-01-29)
   
4. "추가" 클릭
   
5. ✅ 즉시 반영 (다음 문의부터 알림 감)
```

---

### 시나리오 2: 휴가자 일시 비활성화

```
1. 김주영 휴가 (1주일)
   
2. /admin/settings/notifications 접속
   
3. 김주영 행의 "활성" 버튼 클릭
   → "비활성"으로 변경
   
4. 휴가 기간 동안 알림 발송 제외
   
5. 복귀 후 다시 "비활성" 클릭
   → "활성"으로 변경
```

---

### 시나리오 3: DB 오류 시 자동 Fallback

```
상황:
- DB 연결 오류 발생
- 또는 모든 수신자가 is_active=false

자동 동작:
1. getActiveRecipients() 호출
2. DB 조회 실패/0건
3. ENV fallback 자동 작동
4. ADMIN_PHONE_NUMBERS 사용
5. 로그: "ENV fallback"

확인:
[Recipients] DB 조회 실패: connection timeout
[Recipients] ENV fallback
[Recipients] ENV 사용: 1명
[Notify] 발송 성공: recipient_source=env
```

---

## ⚠️ 주의사항

### 1. 활성 수신자 최소 1명 유지

```
❌ 잘못됨
- DB: 0명 (모두 비활성)
- ENV: 미설정
→ 알림 발송 안 됨

✅ 올바름
- DB: 최소 1명 활성
- 또는 ENV 설정 (백업)
```

### 2. E.164 형식 엄격

```
❌ 잘못됨
01012345678      // + 없음
82-10-1234-5678  // + 없음

✅ 올바름
+821012345678
+82-10-1234-5678  // 하이픈은 OK (자동 제거)
```

### 3. ENV는 유지 권장

```
DB가 주 수단이지만 ENV도 유지

이유:
- DB 오류 시 긴급 백업
- 배포 중 접근 불가 시
- 관리자 페이지 문제 시
```

---

## 🐛 문제 해결

### 알림이 안 와요

```bash
# 1. DB 확인
SELECT * FROM admin_notification_recipients WHERE is_active = true;
# → 0건이면 ENV 확인

# 2. ENV 확인
echo $ADMIN_PHONE_NUMBERS
# → 설정되어 있는지 확인

# 3. 로그 확인
npx tsx scripts/test-admin-notification.ts stats

# 4. 테스트 알림 발송
npx tsx scripts/test-admin-notification.ts send
```

---

### DB 수신자가 발송 안 됨

```sql
-- 1. is_active 확인
SELECT id, label, is_active FROM admin_notification_recipients;

-- 2. 전화번호 형식 확인
SELECT label, phone_e164 FROM admin_notification_recipients;
-- → +로 시작하는지 확인

-- 3. 이벤트 로그
SELECT * FROM inquiry_events 
WHERE event_type = 'admin_notify_failed'
ORDER BY created_at DESC LIMIT 5;
```

---

## 📊 기대 효과

| 지표 | Before (ENV만) | After (DB) | 개선 |
|------|---------------|-----------|------|
| 수신자 변경 시간 | 5-10분 (재배포) | **즉시** | 100% ⚡ |
| 휴가 시 처리 | .env 수정 필요 | **UI 클릭** | 편리 ✅ |
| 통계 추적 | 불가능 | **가능** | 신규 📊 |
| 관리자 권한 | 개발자 필요 | **관리자 셀프** | 자율 🎯 |

---

## 📁 새로 추가된 파일 (8개)

1. `migrations/20260129_add_admin_notification_recipients.sql` - DB 테이블
2. `src/lib/notifications/recipients.ts` - 수신자 조회 로직
3. `app/api/admin/notification-recipients/route.ts` - API (GET/POST)
4. `app/api/admin/notification-recipients/[id]/route.ts` - API (PATCH/DELETE)
5. `app/admin/settings/notifications/page.tsx` - 관리자 UI
6. `ADMIN_NOTIFICATIONS_DB_SETUP.md` - DB 기반 가이드
7. `P4.1_EXTENSION_SUMMARY.md` - 본 문서

**수정** (1개):
8. `src/lib/notifications/adminNotifier.ts` - DB 기반으로 확장

---

## 🚀 배포 체크리스트

### 1. DB 마이그레이션
```bash
# Supabase SQL Editor
migrations/20260129_add_admin_notification_recipients.sql
```

### 2. 관리자 페이지 접속 테스트
```
URL: /admin/settings/notifications
→ 목록 표시 확인
```

### 3. 수신자 추가 테스트
```
1. "+ 수신자 추가" 클릭
2. 정보 입력
3. 추가 → 목록에 표시 확인
```

### 4. 알림 발송 테스트
```
1. 문의 1건 제출
2. 휴대폰 알림 수신 확인
3. 관리자 UI에서 sent_count 증가 확인
```

### 5. ENV Fallback 테스트
```
1. DB 모든 수신자 비활성화
2. 문의 1건 제출
3. ENV 번호로 발송되는지 확인
4. 로그: "ENV fallback" 확인
```

---

## 📚 문서 읽는 순서

### 처음 사용
1. `ADMIN_NOTIFICATIONS_DB_SETUP.md` ← **시작**

### 기술적 이해
2. `P4.1_EXTENSION_SUMMARY.md` (본 문서)

### 전체 맥락
3. `P4.1_ADMIN_OPERATIONS_SUMMARY.md` (P4.1 기본)

---

## ✅ 완료 기준

- [x] DB 테이블 생성 및 마이그레이션
- [x] 수신자 조회 로직 (DB 우선 → ENV fallback)
- [x] 알림 발송 로직 확장 (DB 기반)
- [x] 관리자 API (CRUD)
- [x] 관리자 UI (간단한 관리 페이지)
- [x] 전화번호 마스킹 (로그/UI)
- [x] 통계 추적 (sent/failed 수)
- [x] 운영 문서 작성

---

## 🎯 핵심 원칙 (준수 완료)

1. ✅ **Fail-safe**: DB 오류 → ENV fallback
2. ✅ **기존 로직 보호**: 알림 실패 → 메인 로직 영향 없음
3. ✅ **PII 최소화**: 전화번호 마스킹
4. ✅ **DB 우선**: 유연한 관리
5. ✅ **ENV fallback**: 긴급 백업
6. ✅ **Idempotent**: 중복 발송 방지

---

**이제 관리자 페이지에서 유연하게 관리하세요!** 🎛️📱✅
