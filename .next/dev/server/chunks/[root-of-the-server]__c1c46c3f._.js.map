{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 34, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/HEALO_Demo/src/lib/rag/supabaseAdmin.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\";\n\nconst supabaseUrl =\n  process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.VITE_SUPABASE_URL;\nconst serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\nif (!supabaseUrl || !serviceKey) {\n  const missing = [];\n  if (!supabaseUrl) missing.push(\"NEXT_PUBLIC_SUPABASE_URL/VITE_SUPABASE_URL\");\n  if (!serviceKey) missing.push(\"SUPABASE_SERVICE_ROLE_KEY\");\n  throw new Error(`Supabase admin env missing: ${missing.join(\", \")}`);\n}\n\nexport const supabaseAdmin = createClient(supabaseUrl, serviceKey, {\n  auth: { persistSession: false },\n});\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,cACJ,gFAAwC,QAAQ,GAAG,CAAC,iBAAiB;AACvE,MAAM,aAAa,QAAQ,GAAG,CAAC,yBAAyB;AAExD,IAAI,CAAC,eAAe,CAAC,YAAY;IAC/B,MAAM,UAAU,EAAE;IAClB;;IACA,IAAI,CAAC,YAAY,QAAQ,IAAI,CAAC;IAC9B,MAAM,IAAI,MAAM,CAAC,4BAA4B,EAAE,QAAQ,IAAI,CAAC,OAAO;AACrE;AAEO,MAAM,gBAAgB,IAAA,gMAAY,EAAC,aAAa,YAAY;IACjE,MAAM;QAAE,gBAAgB;IAAM;AAChC"}},
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/HEALO_Demo/app/api/chat/route.ts"],"sourcesContent":["import { streamText } from \"ai\";\nimport { openai } from \"@ai-sdk/openai\";\nimport { google } from \"@ai-sdk/google\";\nimport { supabaseAdmin } from \"../../../src/lib/rag/supabaseAdmin\";\n\ntype ChatMessage = { role: string; content: string };\n\nconst isProd = process.env.NODE_ENV === \"production\";\nconst LLM_PROVIDER = (process.env.LLM_PROVIDER || \"openai\").toLowerCase();\n\nconst jsonError = (\n  status: number,\n  code: string,\n  detail?: string,\n  meta?: Record<string, any>\n) => {\n  return Response.json(\n    {\n      ok: false,\n      error: code,\n      ...(isProd ? {} : { detail, meta }),\n    },\n    { status }\n  );\n};\n\nconst getModel = () => {\n  if (LLM_PROVIDER === \"google\") {\n    if (!process.env.GOOGLE_GENERATIVE_AI_API_KEY) {\n      console.error(\"[api/chat] GOOGLE_GENERATIVE_AI_API_KEY is missing\");\n      return { error: jsonError(500, \"google_key_missing\", \"GOOGLE_GENERATIVE_AI_API_KEY is missing\") };\n    }\n    return { model: google(\"gemini-2.0-flash\") as any };\n  }\n  if (!process.env.OPENAI_API_KEY) {\n    console.error(\"[api/chat] OPENAI_API_KEY is missing\");\n    return { error: jsonError(500, \"openai_key_missing\", \"OPENAI_API_KEY is missing\") };\n  }\n  return { model: openai(\"gpt-4o-mini\") as any };\n};\n\nconst classifyOpenAiError = (error: any) => {\n  const message = String(error?.message || \"\");\n  const lower = message.toLowerCase();\n\n  if (lower.includes(\"insufficient_quota\") || lower.includes(\"quota\")) {\n    return { status: 402, code: \"openai_quota_exceeded\", message };\n  }\n  if (lower.includes(\"invalid_api_key\") || lower.includes(\"api key\")) {\n    return { status: 401, code: \"openai_invalid_key\", message };\n  }\n  if (\n    lower.includes(\"model\") &&\n    (lower.includes(\"not found\") || lower.includes(\"does not exist\") || lower.includes(\"access\"))\n  ) {\n    return { status: 403, code: \"openai_model_access\", message };\n  }\n  if (lower.includes(\"rate limit\")) {\n    return { status: 429, code: \"openai_rate_limited\", message };\n  }\n  return { status: 502, code: \"openai_error\", message };\n};\n\nconst classifyGoogleError = (error: any) => {\n  const message = String(error?.message || \"\");\n  const lower = message.toLowerCase();\n\n  if (lower.includes(\"api key\")) {\n    return { status: 401, code: \"google_invalid_key\", message };\n  }\n  if (lower.includes(\"quota\") || lower.includes(\"insufficient\")) {\n    return { status: 402, code: \"google_quota_exceeded\", message };\n  }\n  if (lower.includes(\"permission\") || lower.includes(\"access\")) {\n    return { status: 403, code: \"google_access_denied\", message };\n  }\n  if (lower.includes(\"rate limit\")) {\n    return { status: 429, code: \"google_rate_limited\", message };\n  }\n  return { status: 502, code: \"google_error\", message };\n};\n\nconst buildContext = (chunks: Array<any>) => {\n  if (!Array.isArray(chunks) || chunks.length === 0) return \"\";\n  const lines = chunks.map((c) => {\n    const title = c?.rag_documents?.title ? ` | ${c.rag_documents.title}` : \"\";\n    const source = c?.rag_documents?.source_type\n      ? `[${c.rag_documents.source_type}${title}]`\n      : \"[source]\";\n    return `${source} ${String(c.content || \"\").trim()}`;\n  });\n  return lines.join(\"\\n\\n\");\n};\n\nconst getLastUserMessage = (messages: ChatMessage[] = []) => {\n  for (let i = messages.length - 1; i >= 0; i -= 1) {\n    if (messages[i]?.role === \"user\") return messages[i];\n  }\n  return null;\n};\n\nexport async function POST(request: Request) {\n  let body: any = {};\n  try {\n    body = await request.json();\n  } catch (error: any) {\n    console.error(\"[api/chat] invalid json:\", error);\n    return jsonError(400, \"invalid_json\", error?.message || \"invalid_json\");\n  }\n  const messages: ChatMessage[] = Array.isArray(body?.messages)\n    ? body.messages\n    : [];\n  const lang = body?.lang ? String(body.lang) : \"en\";\n  const sessionId = body?.session_id ? String(body.session_id) : null;\n  const page = body?.page ? String(body.page) : null;\n  const utm = body?.utm && typeof body.utm === \"object\" ? body.utm : null;\n  const lastUser = getLastUserMessage(messages);\n  const query = String(lastUser?.content || \"\").trim();\n\n  if (!query) {\n    return jsonError(400, \"user_message_required\", \"last user message is empty\");\n  }\n\n  // Log normalized inquiry (best effort).\n  void (async () => {\n    try {\n      await supabaseAdmin.from(\"normalized_inquiries\").insert({\n        source_type: \"ai_agent\",\n        language: lang,\n        raw_message: query,\n        constraints: {\n          session_id: sessionId,\n          page,\n          utm,\n        },\n        treatment_slug: null,\n        objective: null,\n      });\n    } catch (error) {\n      console.error(\"[api/chat] normalized_inquiries insert failed:\", error);\n    }\n  })();\n\n  // RAG retrieval (top 6).\n  let ragChunks: any[] = [];\n  try {\n    let q = supabaseAdmin\n      .from(\"rag_chunks\")\n      .select(\n        \"id, document_id, chunk_index, content, rag_documents!inner(id, source_type, source_id, lang, title)\"\n      )\n      .ilike(\"content\", `%${query}%`)\n      .limit(6);\n    if (lang) q = q.eq(\"rag_documents.lang\", lang);\n    const { data, error } = await q;\n    if (!error) ragChunks = data || [];\n    if (error) console.error(\"[api/chat] rag query error:\", error);\n  } catch (error) {\n    console.error(\"[api/chat] rag query failed:\", error);\n  }\n\n  const context = buildContext(ragChunks);\n\n  const systemPrompt = [\n    \"You are a medical concierge assistant for HEALO.\",\n    \"Do not provide diagnosis, medical advice, or guarantees.\",\n    \"Ask clarifying questions when constraints are missing.\",\n    \"Primary objective: guide the user to submit an inquiry.\",\n    \"If relevant, reference the provided context briefly.\",\n    \"\",\n    context ? \"Context:\\n\" + context : \"\",\n  ]\n    .filter(Boolean)\n    .join(\"\\n\");\n\n  const modelResult = getModel();\n  if (modelResult.error) return modelResult.error;\n\n  try {\n    const result = await streamText({\n      model: modelResult.model,\n      system: systemPrompt,\n      messages: messages as any,\n      onError: ({ error }) => {\n        console.error(\"[api/chat] stream error:\", error);\n      },\n    });\n    return result.toDataStreamResponse();\n  } catch (error: any) {\n    console.error(\"[api/chat] LLM error:\", error);\n    const classified =\n      LLM_PROVIDER === \"google\"\n        ? classifyGoogleError(error)\n        : classifyOpenAiError(error);\n    return jsonError(classified.status, classified.code, classified.message);\n  }\n}\n"],"names":[],"mappings":"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"}}]
}