module.exports=[18622,(e,t,r)=>{t.exports=e.x("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js",()=>require("next/dist/compiled/next-server/app-page-turbo.runtime.prod.js"))},56704,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-async-storage.external.js",()=>require("next/dist/server/app-render/work-async-storage.external.js"))},32319,(e,t,r)=>{t.exports=e.x("next/dist/server/app-render/work-unit-async-storage.external.js",()=>require("next/dist/server/app-render/work-unit-async-storage.external.js"))},93695,(e,t,r)=>{t.exports=e.x("next/dist/shared/lib/no-fallback-error.external.js",()=>require("next/dist/shared/lib/no-fallback-error.external.js"))},96670,e=>{"use strict";var t=e.i(24389);let r="https://xppnvkuahlrdyfvabzur.supabase.co",n=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!r||!n){let e=[];throw n||e.push("SUPABASE_SERVICE_ROLE_KEY"),Error(`Supabase admin env missing: ${e.join(", ")}`)}let i=(0,t.createClient)(r,n,{auth:{persistSession:!1}});e.s(["supabaseAdmin",0,i])},53374,e=>{"use strict";function t(e,t,r){return!!t&&String(t)===e||(Array.isArray(r)?r:[]).some(t=>t?.path===e)}e.s(["pathAuthorized",()=>t])},30536,e=>{"use strict";var t=e.i(47909),r=e.i(74017),n=e.i(96250),i=e.i(84243),a=e.i(61916),s=e.i(74677),o=e.i(69741),l=e.i(16795),u=e.i(87718),d=e.i(95169),p=e.i(47587),c=e.i(66012),h=e.i(70101),m=e.i(26937),f=e.i(10372),y=e.i(93695);e.i(52474);var g=e.i(5232),_=e.i(96670),x=e.i(53374);async function b(e){try{let{data:t,error:r}=await _.supabaseAdmin.storage.from("attachments").createSignedUrl(e,300);if(r||!t)return null;return{signedUrl:t.signedUrl,expiresAt:new Date(Date.now()+3e5).toISOString()}}catch{return null}}async function R(e,t,r){let n=[];if(e&&"string"==typeof e&&e.startsWith("inquiry/")&&n.push({path:e,name:null}),Array.isArray(t))for(let e of t)e&&"object"==typeof e&&e.path&&"string"==typeof e.path&&n.push({path:e.path,name:e.name&&"string"==typeof e.name?e.name:null});let{data:i,error:a}=await _.supabaseAdmin.from("inquiries").select("attachment, attachments").eq("id",r).maybeSingle();if(a||!i)return console.error("[buildReferralSummary] inquiry fetch failed for path verification:",a),[];let s=[];for(let{path:e,name:t}of n){if(!(0,x.pathAuthorized)(e,i.attachment??null,i.attachments??[])){console.warn("[buildReferralSummary] path not authorized, skipping:",e);continue}let r=await b(e);r&&s.push({path:e,name:t,signedUrl:r.signedUrl,expiresAt:r.expiresAt})}return s}async function v(e,t){let{data:r,error:n}=await _.supabaseAdmin.from("normalized_inquiries").select("id, source_inquiry_id, country, language, constraints, extraction_confidence, missing_fields").eq("id",e).maybeSingle();if(n||!r)return null;let i=r.constraints&&"object"==typeof r.constraints?r.constraints:{},a=i.intake&&"object"==typeof i.intake?i.intake:{},s=a.complaint&&"object"==typeof a.complaint?a.complaint:{},o=a.history&&"object"==typeof a.history?a.history:{},l=a.logistics&&"object"==typeof a.logistics?a.logistics:{},{data:u,error:d}=await _.supabaseAdmin.from("inquiries").select("attachment, attachments").eq("id",t).maybeSingle();if(d)return null;let p=await R(u?.attachment??null,u?.attachments??[],t);return{patient:{country:r.country??null,language:r.language??null},complaint:{body_part:Array.isArray(s.body_part)?s.body_part:s.body_part?[s.body_part]:null,duration:s.duration&&"string"==typeof s.duration?s.duration:null,severity:"number"==typeof s.severity?s.severity:null,objective:i.objective&&"string"==typeof i.objective?i.objective:null},history:{diagnosis:o.diagnosis&&"object"==typeof o.diagnosis?{has:!!o.diagnosis.has,text:String(o.diagnosis.text||"")}:null,meds:o.meds&&"object"==typeof o.meds?{has:!!o.meds.has,text:String(o.meds.text||"")}:null},logistics:{preferred_date:l.preferred_date&&"string"==typeof l.preferred_date?l.preferred_date:null,flex:!!l.flex},attachments:p,quality:{extraction_confidence:"number"==typeof r.extraction_confidence?r.extraction_confidence:null,missing_fields:Array.isArray(r.missing_fields)?r.missing_fields:null}}}async function A(e){try{let t=await e.json().catch(()=>({})),r=t?.normalizedInquiryId?String(t.normalizedInquiryId):null,n=t?.publicToken?String(t.publicToken):null;if(!r)return Response.json({ok:!1,error:"normalized_inquiry_id_required"},{status:400});if(!n)return Response.json({ok:!1,error:"public_token_required"},{status:400});let{data:i,error:a}=await _.supabaseAdmin.from("normalized_inquiries").select("id, source_inquiry_id").eq("id",r).maybeSingle();if(a)return console.error("[api/referral/summary] normalized_inquiries fetch error:",a),Response.json({ok:!1,error:"normalized_inquiry_fetch_failed"},{status:500});if(!i||!i.source_inquiry_id)return Response.json({ok:!1,error:"normalized_inquiry_not_found"},{status:404});let{data:s,error:o}=await _.supabaseAdmin.from("inquiries").select("id, public_token").eq("id",i.source_inquiry_id).maybeSingle();if(o)return console.error("[api/referral/summary] inquiries fetch error:",o),Response.json({ok:!1,error:"inquiry_fetch_failed"},{status:500});if(!s)return Response.json({ok:!1,error:"inquiry_not_found"},{status:404});let l=s.public_token;if(null==l||String(l)!==String(n))return console.error("[api/referral/summary] public_token mismatch"),Response.json({ok:!1,error:"invalid_public_token"},{status:403});let u=await v(r,i.source_inquiry_id);if(!u)return Response.json({ok:!1,error:"referral_summary_not_found"},{status:404});let d=function(e){let t=[];if(t.push("# Patient Referral Summary"),t.push(""),t.push("## Patient Information"),t.push(`- **Country**: ${e.patient.country||"N/A"}`),t.push(`- **Language**: ${e.patient.language||"N/A"}`),t.push(""),t.push("## Chief Complaint"),e.complaint.body_part?.length&&t.push(`- **Body Part(s)**: ${e.complaint.body_part.join(", ")}`),e.complaint.duration&&t.push(`- **Duration**: ${e.complaint.duration}`),null!=e.complaint.severity&&t.push(`- **Severity**: ${e.complaint.severity}/10`),e.complaint.objective&&t.push(`- **Objective**: ${e.complaint.objective}`),t.push(""),t.push("## Medical History"),e.history.diagnosis&&(t.push(`- **Prior Diagnosis**: ${e.history.diagnosis.has?"Yes":"No"}`),e.history.diagnosis.text&&t.push(`  - Details: ${e.history.diagnosis.text}`)),e.history.meds&&(t.push(`- **Current Medications**: ${e.history.meds.has?"Yes":"No"}`),e.history.meds.text&&t.push(`  - Details: ${e.history.meds.text}`)),t.push(""),t.push("## Logistics"),e.logistics.preferred_date&&t.push(`- **Preferred Date**: ${e.logistics.preferred_date}`),e.logistics.flex&&t.push("- **Date Flexible**: Yes"),t.push(""),e.attachments.length>0){for(let r of(t.push("## Attachments"),e.attachments))t.push(`- ${r.name||r.path} (signed URL, expires: ${new Date(r.expiresAt).toLocaleString()})`),t.push(`  - ${r.signedUrl}`);t.push("")}return t.push("## Data Quality"),null!=e.quality.extraction_confidence&&t.push(`- **Extraction Confidence**: ${Math.round(100*e.quality.extraction_confidence)}%`),e.quality.missing_fields?.length&&t.push(`- **Missing Fields**: ${e.quality.missing_fields.join(", ")}`),t.push(""),t.join("\n")}(u);return console.log("[api/referral/summary] success:",{normalizedInquiryId:r}),Response.json({ok:!0,summaryJson:u,summaryMarkdown:d})}catch(e){return console.error("[api/referral/summary] error:",e),Response.json({ok:!1,error:e?.message||"summary_failed"},{status:500})}}e.s(["POST",()=>A],1391);var w=e.i(1391);let E=new t.AppRouteRouteModule({definition:{kind:r.RouteKind.APP_ROUTE,page:"/api/referral/summary/route",pathname:"/api/referral/summary",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/app/api/referral/summary/route.ts",nextConfigOutput:"",userland:w}),{workAsyncStorage:q,workUnitAsyncStorage:S,serverHooks:j}=E;function C(){return(0,n.patchFetch)({workAsyncStorage:q,workUnitAsyncStorage:S})}async function k(e,t,n){E.isDev&&(0,i.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let _="/api/referral/summary/route";_=_.replace(/\/index$/,"")||"/";let x=await E.prepare(e,t,{srcPage:_,multiZoneDraftMode:!1});if(!x)return t.statusCode=400,t.end("Bad Request"),null==n.waitUntil||n.waitUntil.call(n,Promise.resolve()),null;let{buildId:b,params:R,nextConfig:v,parsedUrl:A,isDraftMode:w,prerenderManifest:q,routerServerContext:S,isOnDemandRevalidate:j,revalidateOnlyGenerated:C,resolvedPathname:k,clientReferenceManifest:P,serverActionsManifest:N}=x,T=(0,o.normalizeAppPath)(_),O=!!(q.dynamicRoutes[T]||q.routes[k]),$=async()=>((null==S?void 0:S.render404)?await S.render404(e,t,A,!1):t.end("This page could not be found"),null);if(O&&!w){let e=!!q.routes[k],t=q.dynamicRoutes[T];if(t&&!1===t.fallback&&!e){if(v.experimental.adapterPath)return await $();throw new y.NoFallbackError}}let U=null;!O||E.isDev||w||(U="/index"===(U=k)?"/":U);let D=!0===E.isDev||!O,I=O&&!D;N&&P&&(0,s.setManifestsSingleton)({page:_,clientReferenceManifest:P,serverActionsManifest:N});let H=e.method||"GET",M=(0,a.getTracer)(),z=M.getActiveScopeSpan(),L={params:R,prerenderManifest:q,renderOpts:{experimental:{authInterrupts:!!v.experimental.authInterrupts},cacheComponents:!!v.cacheComponents,supportsDynamicResponse:D,incrementalCache:(0,i.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:v.cacheLife,waitUntil:n.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,r,n,i)=>E.onRequestError(e,t,n,i,S)},sharedContext:{buildId:b}},F=new l.NodeNextRequest(e),K=new l.NodeNextResponse(t),B=u.NextRequestAdapter.fromNodeNextRequest(F,(0,u.signalFromNodeResponse)(t));try{let s=async e=>E.handle(B,L).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let r=M.getRootSpanAttributes();if(!r)return;if(r.get("next.span_type")!==d.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${r.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let n=r.get("next.route");if(n){let t=`${H} ${n}`;e.setAttributes({"next.route":n,"http.route":n,"next.span_name":t}),e.updateName(t)}else e.updateName(`${H} ${_}`)}),o=!!(0,i.getRequestMeta)(e,"minimalMode"),l=async i=>{var a,l;let u=async({previousCacheEntry:r})=>{try{if(!o&&j&&C&&!r)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await s(i);e.fetchMetrics=L.renderOpts.fetchMetrics;let l=L.renderOpts.pendingWaitUntil;l&&n.waitUntil&&(n.waitUntil(l),l=void 0);let u=L.renderOpts.collectedTags;if(!O)return await (0,c.sendResponse)(F,K,a,L.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,h.toNodeOutgoingHttpHeaders)(a.headers);u&&(t[f.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let r=void 0!==L.renderOpts.collectedRevalidate&&!(L.renderOpts.collectedRevalidate>=f.INFINITE_CACHE)&&L.renderOpts.collectedRevalidate,n=void 0===L.renderOpts.collectedExpire||L.renderOpts.collectedExpire>=f.INFINITE_CACHE?void 0:L.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:r,expire:n}}}}catch(t){throw(null==r?void 0:r.isStale)&&await E.onRequestError(e,t,{routerKind:"App Router",routePath:_,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:I,isOnDemandRevalidate:j})},!1,S),t}},d=await E.handleResponse({req:e,nextConfig:v,cacheKey:U,routeKind:r.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:q,isRoutePPREnabled:!1,isOnDemandRevalidate:j,revalidateOnlyGenerated:C,responseGenerator:u,waitUntil:n.waitUntil,isMinimalMode:o});if(!O)return null;if((null==d||null==(a=d.value)?void 0:a.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==d||null==(l=d.value)?void 0:l.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});o||t.setHeader("x-nextjs-cache",j?"REVALIDATED":d.isMiss?"MISS":d.isStale?"STALE":"HIT"),w&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let y=(0,h.fromNodeOutgoingHttpHeaders)(d.value.headers);return o&&O||y.delete(f.NEXT_CACHE_TAGS_HEADER),!d.cacheControl||t.getHeader("Cache-Control")||y.get("Cache-Control")||y.set("Cache-Control",(0,m.getCacheControlHeader)(d.cacheControl)),await (0,c.sendResponse)(F,K,new Response(d.value.body,{headers:y,status:d.value.status||200})),null};z?await l(z):await M.withPropagatedContext(e.headers,()=>M.trace(d.BaseServerSpan.handleRequest,{spanName:`${H} ${_}`,kind:a.SpanKind.SERVER,attributes:{"http.method":H,"http.target":e.url}},l))}catch(t){if(t instanceof y.NoFallbackError||await E.onRequestError(e,t,{routerKind:"App Router",routePath:T,routeType:"route",revalidateReason:(0,p.getRevalidateReason)({isStaticGeneration:I,isOnDemandRevalidate:j})},!1,S),O)throw t;return await (0,c.sendResponse)(F,K,new Response(null,{status:500})),null}}e.s(["handler",()=>k,"patchFetch",()=>C,"routeModule",()=>E,"serverHooks",()=>j,"workAsyncStorage",()=>q,"workUnitAsyncStorage",()=>S],30536)}];

//# sourceMappingURL=%5Broot-of-the-server%5D__2fd4d767._.js.map