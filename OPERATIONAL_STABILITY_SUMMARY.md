# 운영 안정화 수정 완료 보고서

> 작성일: 2026-01-29  
> 단계: P0 보안/안정성 수정 후 운영 안정화  
> 목표: 운영자 부담 경감 + 리드 품질 관리

---

## 수정 목표

1. ✅ 문의/채팅 데이터가 "조용히 사라지지 않게" 만들기
2. ✅ 스팸/도배/자동화 요청으로 인한 운영 피로 줄이기
3. ✅ 운영자가 상황을 이해할 수 있는 로그/지표 남기기

**중요**: 새로운 비즈니스 기능을 만들지 않고, 기존 플로우를 유지하면서 "더 안전하게, 더 예측 가능하게" 만드는 것이 목적

---

## 1. Rate Limit / Abuse 방어

### 📁 새로 추가된 파일
- `src/lib/rateLimit.ts` (새로 생성)

### 무엇을 바꿨는가?

**추가된 기능**:
- IP 기반 in-memory rate limit
- 자동 cleanup (메모리 누수 방지)
- API별 차별화된 limit 설정

**추천 설정 (보수적)**:
```typescript
RATE_LIMITS = {
  INQUIRY: { windowMs: 60000, maxRequests: 5 },   // 문의: 1분당 5회
  CHAT: { windowMs: 60000, maxRequests: 20 },     // 채팅: 1분당 20회
  NORMALIZE: { windowMs: 60000, maxRequests: 10 } // 내부: 1분당 10회
}
```

### 운영상 어떤 문제가 예방되는가?

| 문제 상황 | 수정 전 | 수정 후 |
|----------|---------|---------|
| 봇이 1초에 100회 문의 제출 | 모두 DB 저장 ⚠️ | 5회 후 차단 ✅ |
| 스크립트로 자동 문의 도배 | DB 오염 ⚠️ | Rate limit 차단 ✅ |
| 정상 사용자 (1분에 2-3회) | 정상 동작 ✅ | 정상 동작 ✅ |

### 왜 지금 단계에서 필요한가?

**운영 리스크**:
- 봇/도배로 인한 DB 오염 → 실제 리드 찾기 어려움
- 운영자가 수백 개의 스팸 문의를 일일이 확인해야 함
- DB 비용 증가 및 성능 저하

**비즈니스 영향**:
- 리드 품질 저하 → 전환율 하락
- 운영 리소스 낭비 → 실제 고객 응대 시간 부족

---

## 2. 실패/차단 사유 로그화

### 📁 새로 추가된 파일
- `src/lib/operationalLog.ts` (새로 생성)

### 무엇을 바꿨는가?

**추가된 로그**:
- `inquiry_received`: 문의 정상 수신
- `inquiry_blocked`: Rate limit 차단
- `inquiry_failed`: 암호화/DB 실패
- `chat_received`: 채팅 정상 수신
- `rate_limit_exceeded`: Rate limit 초과
- `encryption_failed`: 암호화 실패

**로그 형식** (개인정보 제외):
```json
{
  "timestamp": "2026-01-29T10:30:00Z",
  "level": "warn",
  "event": "inquiry_blocked",
  "api": "/api/inquiries/intake",
  "clientIp": "192.168.***.100",
  "reason": "rate_limit_exceeded",
  "statusCode": 429,
  "context": { "limit": 5, "window": "60s" }
}
```

### 운영상 어떤 문제가 예방되는가?

| 상황 | 수정 전 | 수정 후 |
|------|---------|---------|
| "왜 문의가 안 쌓였지?" | 알 수 없음 ⚠️ | 로그에서 사유 확인 ✅ |
| 암호화 키 누락 | 조용히 실패 ⚠️ | 명확한 로그 + 에러 ✅ |
| Rate limit 차단 | 인지 불가 ⚠️ | IP, 차단 사유 기록 ✅ |
| 특정 IP의 반복 실패 | 추적 불가 ⚠️ | 패턴 분석 가능 ✅ |

### 왜 지금 단계에서 필요한가?

**운영자의 고민**:
- "문의가 줄었는데 왜지? 폼이 깨진 건가? 마케팅 문제인가?"
- "특정 시간대에 문의가 급증했다가 사라졌는데 무슨 일인가?"

**로그가 주는 답**:
- "오후 3시에 동일 IP에서 100회 시도 → Rate limit 차단"
- "암호화 키가 잠시 누락되어 10분간 저장 실패 → 즉시 수정"

---

## 3. 문의 상태(state) 최소 정리

### 📁 새로 추가된 파일
- `migrations/20260129_add_inquiry_status.sql` (새로 생성)

### 무엇을 바꿨는가?

**추가된 컬럼** (inquiries 테이블):
```sql
status TEXT DEFAULT 'received'  -- received | blocked | normalized | error
status_reason TEXT              -- 차단/실패 사유
status_updated_at TIMESTAMPTZ   -- 상태 업데이트 시각
```

**상태 정의**:
- `received`: 정상 수신됨 (기본값)
- `blocked`: Rate limit 등으로 차단됨
- `normalized`: 정규화 완료 (normalized_inquiries에 저장됨)
- `error`: 처리 중 에러 발생

**기존 데이터 영향**: 없음 (nullable + 기본값)

### 운영상 어떤 문제가 예방되는가?

| 필요 정보 | 수정 전 | 수정 후 |
|----------|---------|---------|
| 오늘 받은 문의 수 | 전체 카운트만 가능 | 상태별 분류 가능 ✅ |
| 차단된 문의 확인 | 불가능 ⚠️ | `status = 'blocked'` 조회 ✅ |
| 에러 발생 문의 | 추적 어려움 ⚠️ | `status = 'error'` + reason ✅ |
| 문의 처리 현황 | 불명확 ⚠️ | 상태별 대시보드 가능 ✅ |

### 왜 지금 단계에서 필요한가?

**운영자의 니즈**:
- "오늘 받은 실제 문의는 몇 건인가? (스팸 제외)"
- "최근 차단된 문의가 급증했는데 정상 사용자가 막힌 건 아닌가?"
- "처리 실패한 문의를 재처리해야 하는데 어떻게 찾지?"

**상태 컬럼이 주는 답**:
```sql
-- 실제 문의 (스팸 제외)
SELECT COUNT(*) FROM inquiries WHERE status = 'received';

-- 차단된 문의 확인
SELECT * FROM inquiries WHERE status = 'blocked' ORDER BY created_at DESC;

-- 에러 발생 문의 재처리
SELECT * FROM inquiries WHERE status = 'error' AND status_reason LIKE '%encryption%';
```

---

## 4. 서버리스 환경 패턴 정리

### 📁 새로 추가된 파일
- `SERVERLESS_PATTERNS.md` (새로 생성)

### 무엇을 바꿨는가?

**문서화된 내용**:
- ❌ 위험한 패턴 (IIFE, fire-and-forget, setTimeout)
- ✅ 안전한 패턴 (await 완료, try-catch, 작업 분류)
- 📋 체크리스트 (응답 전 완료, 실패 허용, 절대 금지)
- 💡 실전 예시 (Before/After 코드)

**핵심 원칙**:
> "서버리스 환경에서는 응답 반환 후 모든 작업이 즉시 중단될 수 있습니다."

### 운영상 어떤 문제가 예방되는가?

| 위험 상황 | 수정 전 | 수정 후 |
|----------|---------|---------|
| 신규 개발자가 IIFE 사용 | 데이터 유실 발생 ⚠️ | 문서로 명확히 경고 ✅ |
| "빠른 응답" 위해 백그라운드 | 작업 미완료 ⚠️ | 패턴 가이드 제공 ✅ |
| 중요 작업 vs 비중요 구분 | 불명확 ⚠️ | 명시적 주석 패턴 ✅ |

### 왜 지금 단계에서 필요한가?

**반복 방지**:
- P0 수정에서 발견한 문제 (IIFE 백그라운드 실행)
- 같은 실수를 다시 하지 않도록 문서화
- 코드 리뷰 기준 제공

**팀 온보딩**:
- 신규 개발자가 서버리스 환경 이해
- "왜 이렇게 코딩해야 하는지" 명확히 전달
- 베스트 프랙티스 공유

---

## 수정된 API 목록

### 1. `/api/inquiry/normalize` (문의 정규화)
**추가된 기능**:
- ✅ Rate limit (1분당 10회)
- ✅ Rate limit 초과 시 로그 + 429 응답
- ✅ 암호화 실패 시 로그
- ✅ 정규화 성공 시 로그

### 2. `/api/chat` (챗봇)
**추가된 기능**:
- ✅ Rate limit (1분당 20회)
- ✅ Rate limit 초과 시 로그 + 429 응답
- ✅ DB insert 성공/실패 로그
- ✅ 암호화 실패 시 로그

### 3. `/api/inquiries/intake` (문의 제출)
**추가된 기능**:
- ✅ Rate limit (1분당 5회)
- ✅ Rate limit 초과 시 로그 + 429 응답
- ✅ 문의 수신 성공 시 로그
- ✅ 업데이트 실패 시 로그

---

## 전체 수정 요약표

| 항목 | 수정 전 위험도 | 수정 후 상태 | 주요 개선 |
|------|---------------|-------------|----------|
| **봇/도배 방지** | 🔴 높음 | ✅ 해결 | Rate limit 추가, IP 기반 차단 |
| **실패 추적** | 🟠 중간 | ✅ 해결 | 구조화된 로그, 개인정보 제외 |
| **문의 상태 관리** | 🟡 낮음 | ✅ 해결 | 상태 컬럼, 운영 조회 용이 |
| **패턴 가이드** | 🟡 낮음 | ✅ 해결 | 문서화, 반복 실수 방지 |

---

## 운영 시나리오별 개선

### 시나리오 1: 봇이 대량 문의 제출
**수정 전**:
1. 봇이 1초에 100회 문의 제출
2. 모두 DB에 저장됨
3. 운영자가 수동으로 스팸 삭제 필요
4. 실제 리드 찾기 어려움 ⚠️

**수정 후**:
1. 봇이 1초에 100회 문의 시도
2. 5회 후 rate limit 차단 ✅
3. 로그에 IP + 차단 사유 기록
4. 운영자는 실제 리드만 확인 ✅

### 시나리오 2: 암호화 키 누락 (설정 실수)
**수정 전**:
1. 암호화 실패 but 조용히 넘어감
2. 평문 데이터 저장될 뻔 (P0에서 막음)
3. 운영자는 문제 인지 못함 ⚠️

**수정 후**:
1. 암호화 실패 감지
2. 즉시 500 에러 반환
3. 구조화된 로그 기록 ✅
4. 모니터링 시스템에서 알림
5. 빠른 수정 가능 ✅

### 시나리오 3: 정상 사용자가 form을 여러 번 수정
**수정 전**:
1. 사용자가 1분에 2-3회 제출 시도
2. 모두 정상 처리 ✅

**수정 후**:
1. 사용자가 1분에 2-3회 제출 시도
2. Rate limit (5회) 내이므로 정상 처리 ✅
3. 정상 사용자는 영향 없음 ✅

---

## 새로 추가된 파일

### 코드 파일 (3개)
1. `src/lib/rateLimit.ts` - Rate limit 유틸리티
2. `src/lib/operationalLog.ts` - 운영 로그 유틸리티
3. `migrations/20260129_add_inquiry_status.sql` - 문의 상태 컬럼 추가

### 문서 파일 (2개)
1. `SERVERLESS_PATTERNS.md` - 서버리스 환경 안전 패턴
2. `OPERATIONAL_STABILITY_SUMMARY.md` - 본 문서

### 수정된 파일 (3개)
1. `app/api/inquiry/normalize/route.ts` - Rate limit + 로그 추가
2. `app/api/chat/route.ts` - Rate limit + 로그 추가
3. `app/api/inquiries/intake/route.ts` - Rate limit + 로그 추가

---

## 다음 단계 (선택 사항)

### 1. 모니터링 시스템 연동
```typescript
// TODO: Sentry, Datadog 등 연동
logOperational('error', { event: 'encryption_failed', ... });
// → Sentry.captureMessage()
```

### 2. 상태별 대시보드 구축
```sql
-- 운영 대시보드 쿼리
SELECT 
  status,
  COUNT(*) as count,
  MAX(created_at) as last_updated
FROM inquiries
WHERE created_at > NOW() - INTERVAL '24 hours'
GROUP BY status;
```

### 3. Rate Limit 설정 조정
- 초기 설정: 보수적 (정상 사용자 차단 방지)
- 운영 데이터 기반 최적화
- 예: 1분당 5회 → 실제 사용 패턴 보고 조정

---

## 결론

### ✅ 운영 안정화 완료
- 봇/도배 방지: Rate limit ✅
- 실패 추적: 구조화된 로그 ✅
- 문의 상태 관리: 상태 컬럼 ✅
- 패턴 가이드: 문서화 ✅

### 💡 핵심 변경점
1. **조용한 실패 → 명확한 로그**
2. **무방비 → Rate limit 방어**
3. **추적 불가 → 상태 관리 가능**
4. **반복 실수 → 패턴 가이드**

### 🎯 달성한 목표
> "운영자가 덜 불안해지고, 리드 품질이 유지되는 상태"

**완료**: 기능 추가 없이, UI 변경 없이, 운영 안정성 확보 ✅

---

## 운영자를 위한 체크리스트

### 일일 확인 (추천)
- [ ] 오늘 받은 문의 수 (상태별)
- [ ] Rate limit 차단 건수 (정상 사용자가 막혔는지 확인)
- [ ] 에러 로그 확인 (암호화, DB 저장 실패)

### 주간 확인 (추천)
- [ ] 차단된 IP 패턴 분석
- [ ] 문의 처리 흐름 정상 동작 확인
- [ ] Rate limit 설정 조정 필요 여부

### 문제 발생 시
1. **로그 확인**: 구조화된 로그에서 사유 파악
2. **상태 조회**: `status = 'error'` 건 확인
3. **IP 분석**: 특정 IP의 반복 실패 여부

---

**작성자 주석**: 이번 수정은 "더 많은 기능"이 아니라 "더 안전한 운영"에 초점을 맞췄습니다. 운영자가 시스템을 신뢰하고, 문제 발생 시 빠르게 대응할 수 있는 기반을 마련했습니다.
