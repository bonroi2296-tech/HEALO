(()=>{var a={};a.id=93,a.ids=[93],a.modules={261:a=>{"use strict";a.exports=require("next/dist/shared/lib/router/utils/app-paths")},846:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},2280:(a,b,c)=>{"use strict";Object.defineProperty(b,"I",{enumerable:!0,get:function(){return g}});let d=c(8208),e=c(7617),f=c(2018);async function g(a,b,c,g){if((0,d.isNodeNextResponse)(b)){var h;b.statusCode=c.status,b.statusMessage=c.statusText;let d=["set-cookie","www-authenticate","proxy-authenticate","vary"];null==(h=c.headers)||h.forEach((a,c)=>{if("x-middleware-set-cookie"!==c.toLowerCase())if("set-cookie"===c.toLowerCase())for(let d of(0,f.splitCookiesString)(a))b.appendHeader(c,d);else{let e=void 0!==b.getHeader(c);(d.includes(c.toLowerCase())||!e)&&b.appendHeader(c,a)}});let{originalResponse:i}=b;c.body&&"HEAD"!==a.method?await (0,e.pipeToNodeResponse)(c.body,i,g):i.end()}}},3033:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},3042:(a,b,c)=>{"use strict";c.d(b,{BZ:()=>g,LY:()=>f,s6:()=>e});let d=["goal","chief_complaint","body_part","timeline","budget","attachments_present"];function e(a="ai_agent"){return{intake:{goal:null,chief_complaint:null,body_part:null,duration:null,severity:null,budget:null,timeline:null,contraindications:null,medical_history_flag:null,medications_flag:null,allergy_flag:null,previous_procedure_flag:null,attachments_present:null},meta:{pipeline_version:"v1",source_type:a,model:null,prompt_version:null}}}function f(a){let b=[];for(let c of d){let d=a[c];if("attachments_present"===c){null==d&&b.push(c);continue}null!=d&&("string"!=typeof d||String(d).trim())||b.push(c)}return b}function g(a,b){let c=d.length-b.length;return c<=0?0:Math.min(1,Math.round(c/d.length*100)/100)}},3721:(a,b,c)=>{"use strict";c.r(b),c.d(b,{handler:()=>F,patchFetch:()=>E,routeModule:()=>A,serverHooks:()=>D,workAsyncStorage:()=>B,workUnitAsyncStorage:()=>C});var d={};c.r(d),c.d(d,{POST:()=>z});var e=c(9225),f=c(4006),g=c(8317),h=c(9373),i=c(4775),j=c(4235),k=c(261),l=c(4365),m=c(771),n=c(3461),o=c(7798),p=c(2280),q=c(2018),r=c(5696),s=c(7929),t=c(6439),u=c(7527),v=c(8473),w=c(3042),x=c(6612),y=c(7387);async function z(a){try{(0,y.NW)()}catch(a){return console.error("[api/inquiry/normalize] encryption key validation failed:",a),Response.json({ok:!1,error:"encryption_key_missing",detail:a?.message},{status:500})}try{var b,c,d;let e,f,g,h=await a.json().catch(()=>({})),i=h?.text?String(h.text):"",j=h?.inquiry_id!=null?Number(h.inquiry_id):null,k=h?.source_type==="inquiry_form"?"inquiry_form":null,l=h?.source_inquiry_id!=null?Number(h.source_inquiry_id):null,m=h?.session_id!=null?String(h.session_id):null,n=h?.page!=null?String(h.page):null,o=h?.utm&&"object"==typeof h.utm?h.utm:null,p=null!=j||null!=l;if(!i&&!p)return Response.json({ok:!1,error:"text_or_inquiry_id_required"},{status:400});if("inquiry_form"===k&&!p)return console.warn("[api/inquiry/normalize] inquiry_form requires inquiry_id / source_inquiry_id"),Response.json({ok:!1,error:"inquiry_id_required_for_inquiry_form"},{status:400});let q=j??l,r=null;if(q){let{data:a,error:b}=await v.E.from("inquiries").select("id, first_name, last_name, email, nationality, spoken_language, contact_method, contact_id, treatment_type, message, preferred_date, preferred_date_flex, attachment, attachments, intake").eq("id",q).single();if(b)return console.error("[api/inquiry/normalize] inquiries fetch error:",b),Response.json({ok:!1,error:b?.message||"inquiry_fetch_failed"},{status:500});r=a}let s=i||r?.message||null,t=(b=r?.spoken_language,(f=String(b||"").toLowerCase()).includes("ko")||f.includes("kr")||f.includes("korean")?"ko":f.includes("ja")||f.includes("jp")||f.includes("japanese")?"ja":"en"),u=r?"inquiry_form":"ai_agent",z=r?.intake,A=z&&"object"==typeof z&&!Array.isArray(z)&&Object.keys(z).length>0;if(A&&r){let a,b,d,f,g,h;c={intake:r.intake,preferred_date:r.preferred_date??null,preferred_date_flex:r.preferred_date_flex??!1},a=c?.intake&&"object"==typeof c.intake?c.intake:{},b=a?.complaint&&"object"==typeof a.complaint?a.complaint:{},d=a?.history&&"object"==typeof a.history?a.history:{},f=c?.preferred_date?String(c.preferred_date).slice(0,10):null,g=!!c?.preferred_date_flex,h="number"==typeof b.severity?b.severity:null!=b.severity&&""!==b.severity?Number(b.severity):null,e={complaint:{body_part:Array.isArray(b.body_part)?b.body_part:b.body_part?[b.body_part]:null,duration:b.duration&&"string"==typeof b.duration?b.duration:null,severity:null==h||Number.isNaN(h)?null:h},history:{diagnosis:d.diagnosis&&"object"==typeof d.diagnosis?{has:!!d.diagnosis.has,text:String(d.diagnosis.text||"")}:null,meds:d.meds&&"object"==typeof d.meds?{has:!!d.meds.has,text:String(d.meds.text||"")}:null},logistics:{preferred_date:f,flex:g}}}else{let a=function(a){let{intake:b}=(0,w.s6)("inquiry_form");try{let c=a?.message??null,d=a?.treatment_type??null,e=a?.preferred_date??null,f=a?.attachment??null,g=Array.isArray(a?.attachments)?a.attachments:[],h=!!f||g.length>0;b.chief_complaint=c?String(c).trim().slice(0,2e3):null,b.goal=d?String(d):c&&String(c).trim().split(/\n/)[0]?.slice(0,300)||null,b.body_part=(0,x.FJ)(d||c)??null,b.timeline=e?`preferred_date:${String(e).slice(0,10)}`:null,b.budget=null,b.duration=null,b.severity=null;let{contraindications:i,allergy:j,medications:k}=(0,x.SH)(c);b.contraindications=i.length?i:null,b.allergy_flag=j||null,b.medications_flag=k||null,b.medical_history_flag=null,b.previous_procedure_flag=null,b.attachments_present=h}catch{}return b}(r||{}),b=a.timeline?.startsWith("preferred_date:")?String(a.timeline).replace("preferred_date:","").slice(0,10):r?.preferred_date?String(r.preferred_date).slice(0,10):null;e={complaint:{body_part:a.body_part?[a.body_part]:null,duration:a.duration??null,severity:null!=a.severity?Number(a.severity):null},history:{diagnosis:null!=a.medical_history_flag?{has:!!a.medical_history_flag,text:""}:null,meds:null!=a.medications_flag?{has:!!a.medications_flag,text:""}:null},logistics:{preferred_date:b,flex:!!r?.preferred_date_flex}}}let B=r?(d={email:r.email,contact_method:r.contact_method,contact_id:r.contact_id,nationality:r.nationality,spoken_language:r.spoken_language,treatment_type:r.treatment_type,preferred_date:r.preferred_date,preferred_date_flex:r.preferred_date_flex},g=[],d?.email?.trim()||d?.contact_method&&d?.contact_id?.trim()||g.push("contact_reachable"),d?.nationality?.trim()||g.push("nationality"),d?.spoken_language?.trim()||g.push("spoken_language"),d?.treatment_type?.trim()||g.push("treatment_type"),d?.preferred_date?.trim()||d?.preferred_date_flex||g.push("preferred_date_or_flex"),g):[],C=B.length<5?Math.min(1,Math.round((1-B.length/5)*100)/100):0,D={intake:e,meta:{pipeline_version:"v1",source_type:u,model:null,prompt_version:null,source:A?"step2":"step1"}};null!=m&&(D.session_id=m),null!=n&&(D.page=n),null!=o&&(D.utm=o);let E=null,F=null,G=null,H=null;try{E=s?await (0,y.FA)(s):null,F=r?.email?await (0,y.FA)(r.email):null,G=r?.contact_id?await (0,y.FA)(r.contact_id):null,H=r?.email?await (0,y.V3)(r.email):null}catch(a){console.error("[api/inquiry/normalize] encryption error (continuing without encryption):",a?.message)}let{data:I,error:J}=await v.E.from("normalized_inquiries").insert({source_type:u,source_inquiry_id:r?r.id:null,language:t,country:r?.nationality??null,treatment_slug:r?.treatment_type??null,objective:null,constraints:D,raw_message:E,extraction_confidence:C,missing_fields:B.length?B:null,contact:r?{email:F,email_hash:H,messenger_channel:r.contact_method??null,messenger_handle:G}:null}).select("*").single();if(J)return console.error("[api/inquiry/normalize] normalized_inquiries insert failed:",J),Response.json({ok:!0,normalized:null});return Response.json({ok:!0,normalized:I})}catch(a){return console.error("[api/inquiry/normalize] error:",a),Response.json({ok:!1,error:a?.message||"normalize_failed"},{status:500})}}let A=new e.AppRouteRouteModule({definition:{kind:f.RouteKind.APP_ROUTE,page:"/api/inquiry/normalize/route",pathname:"/api/inquiry/normalize",filename:"route",bundlePath:"app/api/inquiry/normalize/route"},distDir:".next",relativeProjectDir:"",resolvedPagePath:"C:\\Users\\user\\Desktop\\HEALO_Demo\\app\\api\\inquiry\\normalize\\route.ts",nextConfigOutput:"",userland:d}),{workAsyncStorage:B,workUnitAsyncStorage:C,serverHooks:D}=A;function E(){return(0,g.patchFetch)({workAsyncStorage:B,workUnitAsyncStorage:C})}async function F(a,b,c){A.isDev&&(0,h.addRequestMeta)(a,"devRequestTimingInternalsEnd",process.hrtime.bigint());let d="/api/inquiry/normalize/route";"/index"===d&&(d="/");let e=await A.prepare(a,b,{srcPage:d,multiZoneDraftMode:!1});if(!e)return b.statusCode=400,b.end("Bad Request"),null==c.waitUntil||c.waitUntil.call(c,Promise.resolve()),null;let{buildId:g,params:v,nextConfig:w,parsedUrl:x,isDraftMode:y,prerenderManifest:z,routerServerContext:B,isOnDemandRevalidate:C,revalidateOnlyGenerated:D,resolvedPathname:E,clientReferenceManifest:F,serverActionsManifest:G}=e,H=(0,k.normalizeAppPath)(d),I=!!(z.dynamicRoutes[H]||z.routes[E]),J=async()=>((null==B?void 0:B.render404)?await B.render404(a,b,x,!1):b.end("This page could not be found"),null);if(I&&!y){let a=!!z.routes[E],b=z.dynamicRoutes[H];if(b&&!1===b.fallback&&!a){if(w.experimental.adapterPath)return await J();throw new t.NoFallbackError}}let K=null;!I||A.isDev||y||(K="/index"===(K=E)?"/":K);let L=!0===A.isDev||!I,M=I&&!L;G&&F&&(0,j.setManifestsSingleton)({page:d,clientReferenceManifest:F,serverActionsManifest:G});let N=a.method||"GET",O=(0,i.getTracer)(),P=O.getActiveScopeSpan(),Q={params:v,prerenderManifest:z,renderOpts:{experimental:{authInterrupts:!!w.experimental.authInterrupts},cacheComponents:!!w.cacheComponents,supportsDynamicResponse:L,incrementalCache:(0,h.getRequestMeta)(a,"incrementalCache"),cacheLifeProfiles:w.cacheLife,waitUntil:c.waitUntil,onClose:a=>{b.on("close",a)},onAfterTaskError:void 0,onInstrumentationRequestError:(b,c,d,e)=>A.onRequestError(a,b,d,e,B)},sharedContext:{buildId:g}},R=new l.NodeNextRequest(a),S=new l.NodeNextResponse(b),T=m.NextRequestAdapter.fromNodeNextRequest(R,(0,m.signalFromNodeResponse)(b));try{let e=async a=>A.handle(T,Q).finally(()=>{if(!a)return;a.setAttributes({"http.status_code":b.statusCode,"next.rsc":!1});let c=O.getRootSpanAttributes();if(!c)return;if(c.get("next.span_type")!==n.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${c.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let e=c.get("next.route");if(e){let b=`${N} ${e}`;a.setAttributes({"next.route":e,"http.route":e,"next.span_name":b}),a.updateName(b)}else a.updateName(`${N} ${d}`)}),g=!!(0,h.getRequestMeta)(a,"minimalMode"),j=async h=>{var i,j;let k=async({previousCacheEntry:f})=>{try{if(!g&&C&&D&&!f)return b.statusCode=404,b.setHeader("x-nextjs-cache","REVALIDATED"),b.end("This page could not be found"),null;let d=await e(h);a.fetchMetrics=Q.renderOpts.fetchMetrics;let i=Q.renderOpts.pendingWaitUntil;i&&c.waitUntil&&(c.waitUntil(i),i=void 0);let j=Q.renderOpts.collectedTags;if(!I)return await (0,p.I)(R,S,d,Q.renderOpts.pendingWaitUntil),null;{let a=await d.blob(),b=(0,q.toNodeOutgoingHttpHeaders)(d.headers);j&&(b[s.NEXT_CACHE_TAGS_HEADER]=j),!b["content-type"]&&a.type&&(b["content-type"]=a.type);let c=void 0!==Q.renderOpts.collectedRevalidate&&!(Q.renderOpts.collectedRevalidate>=s.INFINITE_CACHE)&&Q.renderOpts.collectedRevalidate,e=void 0===Q.renderOpts.collectedExpire||Q.renderOpts.collectedExpire>=s.INFINITE_CACHE?void 0:Q.renderOpts.collectedExpire;return{value:{kind:u.CachedRouteKind.APP_ROUTE,status:d.status,body:Buffer.from(await a.arrayBuffer()),headers:b},cacheControl:{revalidate:c,expire:e}}}}catch(b){throw(null==f?void 0:f.isStale)&&await A.onRequestError(a,b,{routerKind:"App Router",routePath:d,routeType:"route",revalidateReason:(0,o.c)({isStaticGeneration:M,isOnDemandRevalidate:C})},!1,B),b}},l=await A.handleResponse({req:a,nextConfig:w,cacheKey:K,routeKind:f.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:z,isRoutePPREnabled:!1,isOnDemandRevalidate:C,revalidateOnlyGenerated:D,responseGenerator:k,waitUntil:c.waitUntil,isMinimalMode:g});if(!I)return null;if((null==l||null==(i=l.value)?void 0:i.kind)!==u.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==l||null==(j=l.value)?void 0:j.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});g||b.setHeader("x-nextjs-cache",C?"REVALIDATED":l.isMiss?"MISS":l.isStale?"STALE":"HIT"),y&&b.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let m=(0,q.fromNodeOutgoingHttpHeaders)(l.value.headers);return g&&I||m.delete(s.NEXT_CACHE_TAGS_HEADER),!l.cacheControl||b.getHeader("Cache-Control")||m.get("Cache-Control")||m.set("Cache-Control",(0,r.getCacheControlHeader)(l.cacheControl)),await (0,p.I)(R,S,new Response(l.value.body,{headers:m,status:l.value.status||200})),null};P?await j(P):await O.withPropagatedContext(a.headers,()=>O.trace(n.BaseServerSpan.handleRequest,{spanName:`${N} ${d}`,kind:i.SpanKind.SERVER,attributes:{"http.method":N,"http.target":a.url}},j))}catch(b){if(b instanceof t.NoFallbackError||await A.onRequestError(a,b,{routerKind:"App Router",routePath:H,routeType:"route",revalidateReason:(0,o.c)({isStaticGeneration:M,isOnDemandRevalidate:C})},!1,B),I)throw b;return await (0,p.I)(R,S,new Response(null,{status:500})),null}}},4870:a=>{"use strict";a.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},6439:a=>{"use strict";a.exports=require("next/dist/shared/lib/no-fallback-error.external")},6487:()=>{},6612:(a,b,c)=>{"use strict";c.d(b,{FJ:()=>f,SH:()=>g,b2:()=>k,h7:()=>h,ir:()=>j,jR:()=>i});let d=[[/nose|rhinoplasty|nasal/i,"nose"],[/skin|acne|facial|laser|botox|filler/i,"skin"],[/breast|augmentation|implants/i,"breast"],[/hair|transplant|follicle/i,"hair"],[/eye|lasik|eyelid|double eyelid/i,"eye"],[/abdomen|tummy|liposuction|belly/i,"abdomen"],[/chin|jaw/i,"chin"],[/dental|implant|tooth|teeth/i,"dental"]],e=[[/allergy|allergic/i,"allergy"],[/medication|medicine|meds|drug/i,"medication"],[/diabetes|diabetic/i,"diabetes"],[/pregnant|pregnancy/i,"pregnant"]];function f(a){let b=String(a||"").toLowerCase();if(!b)return null;for(let[a,c]of d)if("string"==typeof a?b.includes(a):a.test(b))return c;return null}function g(a){let b=String(a||"").toLowerCase(),c=[],d=!1,f=!1;for(let[a,g]of e)("string"==typeof a?b.includes(a):a.test(b))&&(c.push(g),"allergy"===g&&(d=!0),"medication"===g&&(f=!0));return{contraindications:c,allergy:d,medications:f}}function h(a){let b=String(a||"").toLowerCase();if(/\basap\b|as soon|urgent/i.test(b))return"asap";if(/1-3\s*month|1\s*to\s*3\s*m|within 3\s*m/i.test(b))return"1-3m";if(/3-6\s*month|3\s*to\s*6\s*m/i.test(b))return"3-6m";if(/6\s*month|6m\+|6m\s*plus/i.test(b))return"6m+";let c=b.match(/\b(20\d{2})-(\d{2})-(\d{2})\b/);if(c)return`preferred_date:${c[0]}`;let d=b.match(/\b(\d{1,2})\/(\d{1,2})\/(\d{4})\b/);return d?`preferred_date:${d[3]}-${d[1].padStart(2,"0")}-${d[2].padStart(2,"0")}`:null}function i(a){let b=String(a||"").toLowerCase();if(/\bbudget\b|price|cost|usd|won|\$|₩|krw/i.test(b)){let a=b.match(/(\d[\d,.]*)\s*(k|m|million|thousand)?\s*(usd|won|krw|\$|₩)?/i);return a?a[0].trim().slice(0,50):"mentioned"}return null}function j(a){let b=String(a||"").toLowerCase();return/\b1w\b|1\s*week/i.test(b)?"1w":/\b1m\b|1\s*month/i.test(b)?"1m":/\b3m\b|3\s*month/i.test(b)?"3m":/\b6m\b|6\s*month/i.test(b)?"6m":/\b1y\b|1\s*year|1y\+/i.test(b)?"1y+":null}function k(a){let b=String(a||"").toLowerCase();if(/\bmild\b|minor|slight/i.test(b))return"mild";if(/\bmedium\b|moderate/i.test(b))return"medium";if(/\bsevere\b|serious|bad/i.test(b))return"severe";let c=b.match(/\b([0-9]|10)\s*\/\s*10\b|\b([0-9]|10)-10\b/);return c?c[0].slice(0,20):null}},7387:(a,b,c)=>{"use strict";c.d(b,{FA:()=>g,NW:()=>f,V3:()=>h});var d=c(8473);let e=process.env.SUPABASE_ENCRYPTION_KEY;function f(){if(!e){let a=Error("[security/encryption] SUPABASE_ENCRYPTION_KEY is missing. 암호화 키가 설정되지 않았습니다. 환경변수를 확인하세요. 키 분실/변경 시 기존 데이터 복호화 불가.");throw console.error(a.message),a}if(e.length<32){let a=Error(`[security/encryption] SUPABASE_ENCRYPTION_KEY is too short (${e.length} < 32). 암호화 키는 최소 32자 이상이어야 합니다. 키 분실/변경 시 기존 데이터 복호화 불가.`);throw console.error(a.message),a}}async function g(a){if(f(),!a)return null;try{let{data:b,error:c}=await d.E.rpc("encrypt_text",{plaintext:String(a),encryption_key:e});if(c)return console.error("[security/encryption] encrypt error:",c),null;return b}catch(a){return console.error("[security/encryption] encrypt exception:",a),null}}async function h(a){if(!a)return null;try{let{data:b,error:c}=await d.E.rpc("email_hash",{email:String(a)});if(c)return console.error("[security/encryption] hash error:",c),null;return b}catch(a){return console.error("[security/encryption] hash exception:",a),null}}},8335:()=>{},8473:(a,b,c)=>{"use strict";c.d(b,{E:()=>g});var d=c(1837);let e="https://xppnvkuahlrdyfvabzur.supabase.co",f=process.env.SUPABASE_SERVICE_ROLE_KEY;if(!e||!f){let a=[];throw e||a.push("NEXT_PUBLIC_SUPABASE_URL/VITE_SUPABASE_URL"),f||a.push("SUPABASE_SERVICE_ROLE_KEY"),Error(`Supabase admin env missing: ${a.join(", ")}`)}let g=(0,d.UU)(e,f,{auth:{persistSession:!1}})},9225:(a,b,c)=>{"use strict";a.exports=c(4870)},9294:a=>{"use strict";a.exports=require("next/dist/server/app-render/work-async-storage.external.js")}};var b=require("../../../../webpack-runtime.js");b.C(a);var c=b.X(0,[741,218],()=>b(b.s=3721));module.exports=c})();