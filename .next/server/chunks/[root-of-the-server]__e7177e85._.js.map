{"version":3,"sources":["../../../src/lib/rag/supabaseAdmin.ts","../../../src/lib/intakeSchema.ts","../../../src/lib/intakeExtract.ts","../../../src/lib/security/encryption.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\";\n\nconst supabaseUrl =\n  process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.VITE_SUPABASE_URL;\nconst serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\nif (!supabaseUrl || !serviceKey) {\n  const missing = [];\n  if (!supabaseUrl) missing.push(\"NEXT_PUBLIC_SUPABASE_URL/VITE_SUPABASE_URL\");\n  if (!serviceKey) missing.push(\"SUPABASE_SERVICE_ROLE_KEY\");\n  throw new Error(`Supabase admin env missing: ${missing.join(\", \")}`);\n}\n\nexport const supabaseAdmin = createClient(supabaseUrl, serviceKey, {\n  auth: { persistSession: false },\n});\n","/**\n * IntakeSchema — normalized_inquiries.constraints 고정 스키마\n * AI Agent(/api/chat) + Inquiry Form(/api/inquiry/normalize) 공통 적재용\n */\n\nexport type Intake = {\n  goal: string | null;\n  chief_complaint: string | null;\n  body_part: string | null;\n  duration: string | null;\n  severity: string | null;\n  budget: string | null;\n  timeline: string | null;\n  contraindications: string[] | null;\n  medical_history_flag: boolean | null;\n  medications_flag: boolean | null;\n  allergy_flag: boolean | null;\n  previous_procedure_flag: boolean | null;\n  attachments_present: boolean | null;\n};\n\nexport type IntakeMeta = {\n  pipeline_version: string;\n  source_type: \"ai_agent\" | \"inquiry_form\";\n  model: string | null;\n  prompt_version: string | null;\n};\n\n/** 필수 6개 — 누락 판단 기준 */\nconst REQUIRED_KEYS: (keyof Intake)[] = [\n  \"goal\",\n  \"chief_complaint\",\n  \"body_part\",\n  \"timeline\",\n  \"budget\",\n  \"attachments_present\",\n];\n\n/**\n * 빈 Intake + Meta 기본값\n */\nexport function createEmptyIntake(\n  source_type: \"ai_agent\" | \"inquiry_form\" = \"ai_agent\"\n): { intake: Intake; meta: IntakeMeta } {\n  const intake: Intake = {\n    goal: null,\n    chief_complaint: null,\n    body_part: null,\n    duration: null,\n    severity: null,\n    budget: null,\n    timeline: null,\n    contraindications: null,\n    medical_history_flag: null,\n    medications_flag: null,\n    allergy_flag: null,\n    previous_procedure_flag: null,\n    attachments_present: null,\n  };\n  const meta: IntakeMeta = {\n    pipeline_version: \"v1\",\n    source_type,\n    model: null,\n    prompt_version: null,\n  };\n  return { intake, meta };\n}\n\n/**\n * 누락 필드 목록 (필수 6개 기준)\n */\nexport function computeMissingFields(intake: Intake): string[] {\n  const missing: string[] = [];\n  for (const k of REQUIRED_KEYS) {\n    const v = intake[k];\n    if (k === \"attachments_present\") {\n      if (v === null || v === undefined) missing.push(k);\n      continue;\n    }\n    if (v === null || v === undefined || (typeof v === \"string\" && !String(v).trim())) {\n      missing.push(k);\n    }\n  }\n  return missing;\n}\n\n/**\n * 추출 신뢰도 0~1 (필수 6개 중 채워진 비율)\n */\nexport function computeExtractionConfidence(\n  intake: Intake,\n  missing_fields: string[]\n): number {\n  const filled = REQUIRED_KEYS.length - missing_fields.length;\n  if (filled <= 0) return 0;\n  return Math.min(1, Math.round((filled / REQUIRED_KEYS.length) * 100) / 100);\n}\n","/**\n * Intake 추출용 키워드/패턴 유틸 (normalize + chat 공용)\n */\n\nconst BODY_PART_KEYWORDS: [RegExp | string, string][] = [\n  [/nose|rhinoplasty|nasal/i, \"nose\"],\n  [/skin|acne|facial|laser|botox|filler/i, \"skin\"],\n  [/breast|augmentation|implants/i, \"breast\"],\n  [/hair|transplant|follicle/i, \"hair\"],\n  [/eye|lasik|eyelid|double eyelid/i, \"eye\"],\n  [/abdomen|tummy|liposuction|belly/i, \"abdomen\"],\n  [/chin|jaw/i, \"chin\"],\n  [/dental|implant|tooth|teeth/i, \"dental\"],\n];\n\nconst CONTRAINDICATION_KEYWORDS: [RegExp | string, string][] = [\n  [/allergy|allergic/i, \"allergy\"],\n  [/medication|medicine|meds|drug/i, \"medication\"],\n  [/diabetes|diabetic/i, \"diabetes\"],\n  [/pregnant|pregnancy/i, \"pregnant\"],\n];\n\nexport function bodyPartFromText(text: string | null | undefined): string | null {\n  const s = String(text || \"\").toLowerCase();\n  if (!s) return null;\n  for (const [pattern, part] of BODY_PART_KEYWORDS) {\n    if (typeof pattern === \"string\" ? s.includes(pattern) : pattern.test(s)) return part;\n  }\n  return null;\n}\n\nexport function contraindicationsAndFlagsFromMessage(\n  message: string | null | undefined\n): { contraindications: string[]; allergy: boolean; medications: boolean } {\n  const s = String(message || \"\").toLowerCase();\n  const contraindications: string[] = [];\n  let allergy = false;\n  let medications = false;\n  for (const [pattern, label] of CONTRAINDICATION_KEYWORDS) {\n    const match = typeof pattern === \"string\" ? s.includes(pattern) : pattern.test(s);\n    if (match) {\n      contraindications.push(label);\n      if (label === \"allergy\") allergy = true;\n      if (label === \"medication\") medications = true;\n    }\n  }\n  return { contraindications, allergy, medications };\n}\n\n/** query에서 timeline 추출 (asap, 1-3m, preferred_date 등) */\nexport function extractTimelineFromQuery(q: string): string | null {\n  const s = String(q || \"\").toLowerCase();\n  if (/\\basap\\b|as soon|urgent/i.test(s)) return \"asap\";\n  if (/1-3\\s*month|1\\s*to\\s*3\\s*m|within 3\\s*m/i.test(s)) return \"1-3m\";\n  if (/3-6\\s*month|3\\s*to\\s*6\\s*m/i.test(s)) return \"3-6m\";\n  if (/6\\s*month|6m\\+|6m\\s*plus/i.test(s)) return \"6m+\";\n  const iso = s.match(/\\b(20\\d{2})-(\\d{2})-(\\d{2})\\b/);\n  if (iso) return `preferred_date:${iso[0]}`;\n  const us = s.match(/\\b(\\d{1,2})\\/(\\d{1,2})\\/(\\d{4})\\b/);\n  if (us) return `preferred_date:${us[3]}-${us[1].padStart(2, \"0\")}-${us[2].padStart(2, \"0\")}`;\n  return null;\n}\n\n/** query에서 budget 추출 */\nexport function extractBudgetFromQuery(q: string): string | null {\n  const s = String(q || \"\").toLowerCase();\n  if (/\\bbudget\\b|price|cost|usd|won|\\$|₩|krw/i.test(s)) {\n    const m = s.match(/(\\d[\\d,.]*)\\s*(k|m|million|thousand)?\\s*(usd|won|krw|\\$|₩)?/i);\n    if (m) return m[0].trim().slice(0, 50);\n    return \"mentioned\";\n  }\n  return null;\n}\n\n/** query에서 duration 추출 (1w, 1m, 3m, 6m, 1y+) */\nexport function extractDurationFromQuery(q: string): string | null {\n  const s = String(q || \"\").toLowerCase();\n  if (/\\b1w\\b|1\\s*week/i.test(s)) return \"1w\";\n  if (/\\b1m\\b|1\\s*month/i.test(s)) return \"1m\";\n  if (/\\b3m\\b|3\\s*month/i.test(s)) return \"3m\";\n  if (/\\b6m\\b|6\\s*month/i.test(s)) return \"6m\";\n  if (/\\b1y\\b|1\\s*year|1y\\+/i.test(s)) return \"1y+\";\n  return null;\n}\n\n/** query에서 severity 추출 */\nexport function extractSeverityFromQuery(q: string): string | null {\n  const s = String(q || \"\").toLowerCase();\n  if (/\\bmild\\b|minor|slight/i.test(s)) return \"mild\";\n  if (/\\bmedium\\b|moderate/i.test(s)) return \"medium\";\n  if (/\\bsevere\\b|serious|bad/i.test(s)) return \"severe\";\n  const scale = s.match(/\\b([0-9]|10)\\s*\\/\\s*10\\b|\\b([0-9]|10)-10\\b/);\n  if (scale) return scale[0].slice(0, 20);\n  return null;\n}\n","/**\n * HEALO: 서버 사이드 암호화 유틸리티\n * pgcrypto 함수를 호출하여 데이터 암호화/복호화\n * 주의: 클라이언트에서는 사용하지 않음\n */\n\nimport { supabaseAdmin } from \"../rag/supabaseAdmin\";\n\nconst ENCRYPTION_KEY = process.env.SUPABASE_ENCRYPTION_KEY;\nconst MIN_KEY_LENGTH = 32;\n\n/**\n * 암호화 키 검증 (서버 부팅 시/암호화 호출 전에 실행)\n * 키가 없거나 길이가 부족하면 즉시 에러 발생\n * @throws Error 키 누락 또는 길이 부족 시\n */\nexport function assertEncryptionKey(): void {\n  if (!ENCRYPTION_KEY) {\n    const error = new Error(\n      \"[security/encryption] SUPABASE_ENCRYPTION_KEY is missing. \" +\n      \"암호화 키가 설정되지 않았습니다. 환경변수를 확인하세요. \" +\n      \"키 분실/변경 시 기존 데이터 복호화 불가.\"\n    );\n    console.error(error.message);\n    throw error;\n  }\n\n  if (ENCRYPTION_KEY.length < MIN_KEY_LENGTH) {\n    const error = new Error(\n      `[security/encryption] SUPABASE_ENCRYPTION_KEY is too short (${ENCRYPTION_KEY.length} < ${MIN_KEY_LENGTH}). ` +\n      `암호화 키는 최소 ${MIN_KEY_LENGTH}자 이상이어야 합니다. ` +\n      \"키 분실/변경 시 기존 데이터 복호화 불가.\"\n    );\n    console.error(error.message);\n    throw error;\n  }\n}\n\n// 개발 환경에서만 경고 (프로덕션에서는 각 route에서 assertEncryptionKey() 호출)\nif (process.env.NODE_ENV !== \"production\") {\n  if (!ENCRYPTION_KEY || ENCRYPTION_KEY.length < MIN_KEY_LENGTH) {\n    console.warn(\n      \"[security/encryption] WARNING: SUPABASE_ENCRYPTION_KEY is missing or too short. \" +\n      \"암호화 기능이 정상 작동하지 않을 수 있습니다.\"\n    );\n  }\n}\n\n/**\n * 텍스트 암호화 (서버에서만 사용)\n * @param plaintext 암호화할 텍스트\n * @returns base64 인코딩된 암호화 문자열 또는 null\n */\nexport async function encryptText(\n  plaintext: string | null | undefined\n): Promise<string | null> {\n  // 키 검증 (암호화 전에 수행)\n  assertEncryptionKey();\n\n  if (!plaintext) {\n    return null;\n  }\n\n  try {\n    const { data, error } = await supabaseAdmin.rpc(\"encrypt_text\", {\n      plaintext: String(plaintext),\n      encryption_key: ENCRYPTION_KEY,\n    });\n\n    if (error) {\n      console.error(\"[security/encryption] encrypt error:\", error);\n      return null;\n    }\n\n    return data as string | null;\n  } catch (error) {\n    console.error(\"[security/encryption] encrypt exception:\", error);\n    return null;\n  }\n}\n\n/**\n * 텍스트 복호화 (서버에서만 사용)\n * @param ciphertext base64 인코딩된 암호화 문자열\n * @returns 복호화된 텍스트 또는 null\n */\nexport async function decryptText(\n  ciphertext: string | null | undefined\n): Promise<string | null> {\n  // 키 검증 (복호화 전에 수행)\n  assertEncryptionKey();\n\n  if (!ciphertext) {\n    return null;\n  }\n\n  try {\n    const { data, error } = await supabaseAdmin.rpc(\"decrypt_text\", {\n      ciphertext: String(ciphertext),\n      encryption_key: ENCRYPTION_KEY,\n    });\n\n    if (error) {\n      console.error(\"[security/encryption] decrypt error:\", error);\n      return null;\n    }\n\n    return data as string | null;\n  } catch (error) {\n    console.error(\"[security/encryption] decrypt exception:\", error);\n    return null;\n  }\n}\n\n/**\n * Email 해시 생성 (검색용, 복호화 불가)\n * @param email 이메일 주소\n * @returns sha256 해시 (hex) 또는 null\n */\nexport async function hashEmail(\n  email: string | null | undefined\n): Promise<string | null> {\n  if (!email) {\n    return null;\n  }\n\n  try {\n    const { data, error } = await supabaseAdmin.rpc(\"email_hash\", {\n      email: String(email),\n    });\n\n    if (error) {\n      console.error(\"[security/encryption] hash error:\", error);\n      return null;\n    }\n\n    return data as string | null;\n  } catch (error) {\n    console.error(\"[security/encryption] hash exception:\", error);\n    return null;\n  }\n}\n"],"names":[],"mappings":"msBAAA,IAAA,EAAA,EAAA,CAAA,CAAA,OAEA,IAAM,EACJ,YAAA,+BACI,EAAa,EADuB,MACf,EADuB,CACpB,CAAC,CADsB,CAAC,iBAAiB,MACf,CAExD,GAAI,CAAC,GAAe,CAAC,EAAY,CAC/B,IAAM,EAAU,EAGhB,AAHkB,OAEd,AAAC,GAAY,EAAQ,IAAI,CAAC,6BACxB,AAAI,MAAM,CAAC,4BAA4B,EAAE,EAAQ,IAAI,CAAC,MAAA,CAAO,CACrE,CAEO,IAAM,EAAgB,CAAA,EAAA,EAAA,YAAA,AAAY,EAAC,EAAa,EAAY,CACjE,KAAM,CAAE,gBAAgB,CAAM,CAChC,kECcA,IAAM,EAAkC,CACtC,OACA,kBACA,YACA,WACA,SACA,sBACD,CAKM,SAAS,EACd,EAA2C,UAAU,EAuBrD,MAAO,CAAE,OArBc,CACrB,KAAM,KACN,gBAAiB,KACjB,UAAW,KACX,SAAU,KACV,SAAU,KACV,OAAQ,KACR,SAAU,KACV,kBAAmB,KACnB,qBAAsB,KACtB,iBAAkB,KAClB,aAAc,KACd,wBAAyB,KACzB,oBAAqB,IACvB,EAOiB,KANQ,CACvB,iBAAkB,iBAClB,EACA,MAAO,KACP,eAAgB,IAClB,CACsB,CACxB,CAKO,SAAS,EAAqB,CAAc,EACjD,IAAM,EAAoB,EAAE,CAC5B,IAAK,IAAM,KAAK,EAAe,CAC7B,IAAM,EAAI,CAAM,CAAC,EAAE,CACnB,GAAU,wBAAN,EAA6B,OAC3B,GAA+B,EAAQ,CAAjC,GAAqC,CAAC,GAChD,CADkB,MAAM,CAE1B,OACI,IAA+C,EAAzC,QAAQ,AAAoB,EAAyB,IAAvC,CAAqB,GAAmB,OAAO,GAAG,IAAI,EAAA,GAAK,AACjF,EAAQ,IAAI,CAAC,EAEjB,CACA,OAAO,CACT,CAKO,SAAS,EACd,CAAc,CACd,CAAwB,EAExB,IAAM,EAAS,EAAc,MAAM,CAAG,EAAe,MAAM,QAC3D,AAAI,GAAU,EAAU,CAAP,CACV,KAAK,GAAG,CAAC,EAAG,KAAK,KAAK,CAAE,EAAS,EAAc,MAAM,CAAI,KAAO,IACzE,yGC5FA,IAAM,EAAkD,CACtD,CAAC,0BAA2B,OAAO,CACnC,CAAC,uCAAwC,OAAO,CAChD,CAAC,gCAAiC,SAAS,CAC3C,CAAC,4BAA6B,OAAO,CACrC,CAAC,kCAAmC,MAAM,CAC1C,CAAC,mCAAoC,UAAU,CAC/C,CAAC,YAAa,OAAO,CACrB,CAAC,8BAA+B,SAAS,CAC1C,CAEK,EAAyD,CAC7D,CAAC,oBAAqB,UAAU,CAChC,CAAC,iCAAkC,aAAa,CAChD,CAAC,qBAAsB,WAAW,CAClC,CAAC,sBAAuB,WAAW,CACpC,CAEM,SAAS,EAAiB,CAA+B,EAC9D,IAAM,EAAI,OAAO,GAAQ,IAAI,WAAW,GACxC,GAAI,CAAC,EAAG,OAAO,KACf,IAAK,GAAM,CAAC,EAAS,EAAK,GAAI,EAC5B,GAAuB,UAAnB,IAD4C,GACrC,EAAuB,EAAE,QAAQ,CAAC,GAAW,EAAQ,IAAI,CAAC,GAAI,OAAO,EAElF,OAAO,IACT,CAEO,SAAS,EACd,CAAkC,EAElC,IAAM,EAAI,OAAO,GAAW,IAAI,WAAW,GACrC,EAA8B,EAAE,CAClC,GAAU,EACV,GAAc,EAClB,IAAK,GAAM,CAAC,EAAS,EAAM,GAAI,GACI,UAAnB,OAAO,EAAuB,EAAE,EADU,MACF,CAAC,GAAW,EAAQ,IAAI,CAAC,EAAA,IAE7E,EAAkB,IAAI,CAAC,GACT,YAAV,IAAqB,GAAU,CAAA,EACrB,eAAV,IAAwB,GAAc,CAAA,GAG9C,MAAO,mBAAE,UAAmB,EAAS,aAAY,CACnD,CAGO,SAAS,EAAyB,CAAS,EAChD,IAAM,EAAI,OAAO,GAAK,IAAI,WAAW,GACrC,GAAI,2BAA2B,IAAI,CAAC,GAAI,MAAO,OAC/C,GAAI,2CAA2C,IAAI,CAAC,GAAI,MAAO,OAC/D,GAAI,8BAA8B,IAAI,CAAC,GAAI,MAAO,OAClD,GAAI,4BAA4B,IAAI,CAAC,GAAI,MAAO,MAChD,IAAM,EAAM,EAAE,KAAK,CAAC,iCACpB,GAAI,EAAK,MAAO,CAAC,eAAe,EAAE,CAAG,CAAC,EAAE,CAAA,CAAE,CAC1C,IAAM,EAAK,EAAE,KAAK,CAAC,4CACnB,AAAI,EAAW,CAAC,CAAR,cAAuB,EAAE,CAAE,CAAC,EAAE,CAAC,CAAC,EAAE,CAAE,CAAC,EAAE,CAAC,QAAQ,CAAC,EAAG,KAAK,CAAC,EAAE,CAAE,CAAC,EAAE,CAAC,QAAQ,CAAC,EAAG,KAAA,CAAM,CACrF,IACT,CAGO,SAAS,EAAuB,CAAS,EAC9C,IAAM,EAAI,OAAO,GAAK,IAAI,WAAW,GACrC,GAAI,0CAA0C,IAAI,CAAC,GAAI,CACrD,IAAM,EAAI,EAAE,KAAK,CAAC,uEAClB,AAAI,EAAU,CAAP,AAAQ,CAAC,EAAE,CAAC,IAAI,GAAG,KAAK,CAAC,EAAG,IAC5B,WACT,CACA,OAAO,IACT,CAGO,SAAS,EAAyB,CAAS,EAChD,IAAM,EAAI,OAAO,GAAK,IAAI,WAAW,SACrC,AAAI,mBAAmB,IAAI,CAAC,GAAW,CAAP,IAC5B,oBAAoB,IAAI,CAAC,GAAW,CAAP,IAC7B,oBAAoB,IAAI,CAAC,GAAW,CAAP,IAC7B,oBAAoB,IAAI,CAAC,GAAW,CAAP,IAC7B,wBAAwB,IAAI,CAAC,GAAW,CAAP,KAC9B,IACT,CAGO,SAAS,EAAyB,CAAS,EAChD,IAAM,EAAI,OAAO,GAAK,IAAI,WAAW,GACrC,GAAI,yBAAyB,IAAI,CAAC,GAAI,MAAO,OAC7C,GAAI,uBAAuB,IAAI,CAAC,GAAI,MAAO,SAC3C,GAAI,0BAA0B,IAAI,CAAC,GAAI,MAAO,SAC9C,IAAM,EAAQ,EAAE,KAAK,CAAC,qDACtB,AAAI,EAAc,CAAK,CAAC,EAAE,CAAf,AAAgB,KAAK,CAAC,EAAG,IAC7B,IACT,sNCxFA,IAAA,EAAA,EAAA,CAAA,CAAA,OAEA,IAAM,EAAiB,QAAQ,GAAG,CAAC,uBAAuB,CAQnD,SAAS,IACd,GAAI,CAAC,EAAgB,CACnB,IAAM,EAAQ,AAAI,MAChB,+DACA,qCACA,iBAGF,OADA,QAAQ,KAAK,CAAC,EAAM,OAAO,EACrB,CACR,CAEA,GAAI,EAAe,MAAM,CAlBJ,EAkBO,CAAgB,CAC1C,IAAM,EAAQ,AAAI,MAChB,CAAC,4DAA4D,EAAE,EAAe,MAAM,CAAC,GAAG,EAAE,eAAe,GAAG,mCAAC,CAK/G,EAJE,CAAC,IAGH,MAHa,EAAE,AAGP,KAAK,CAAC,EAAM,OAHU,AAGH,EACrB,CACR,CACF,CAiBO,QAvBwC,CAAC,GAC1C,GAsBgB,EACpB,CAAoC,EAKpC,GAFA,IAEI,CAAC,EACH,OAAO,EADO,GAIhB,GAAI,CACF,GAAM,MAAE,CAAI,OAAE,CAAK,CAAE,CAAG,MAAM,EAAA,aAAa,CAAC,GAAG,CAAC,eAAgB,CAC9D,UAAW,OAAO,GAClB,eAAgB,CAClB,GAEA,GAAI,EAEF,KAFS,EACT,QAAQ,KAAK,CAAC,uCAAwC,GAC/C,KAGT,OAAO,CACT,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,2CAA4C,GACnD,IACT,CACF,CAwCO,eAAe,EACpB,CAAgC,EAEhC,GAAI,CAAC,EACH,KADU,EACH,KAGT,GAAI,CACF,GAAM,CAAE,MAAI,OAAE,CAAK,CAAE,CAAG,MAAM,EAAA,aAAa,CAAC,GAAG,CAAC,aAAc,CAC5D,MAAO,OAAO,EAChB,GAEA,GAAI,EAEF,KAFS,EACT,QAAQ,KAAK,CAAC,oCAAqC,GAC5C,KAGT,OAAO,CACT,CAAE,MAAO,EAAO,CAEd,OADA,QAAQ,KAAK,CAAC,wCAAyC,GAChD,IACT,CACF"}