{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 34, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/HEALO_Demo/src/lib/rag/supabaseAdmin.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\";\n\nconst supabaseUrl =\n  process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.VITE_SUPABASE_URL;\nconst serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\nif (!supabaseUrl || !serviceKey) {\n  const missing = [];\n  if (!supabaseUrl) missing.push(\"NEXT_PUBLIC_SUPABASE_URL/VITE_SUPABASE_URL\");\n  if (!serviceKey) missing.push(\"SUPABASE_SERVICE_ROLE_KEY\");\n  throw new Error(`Supabase admin env missing: ${missing.join(\", \")}`);\n}\n\nexport const supabaseAdmin = createClient(supabaseUrl, serviceKey, {\n  auth: { persistSession: false },\n});\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,cACJ,gFAAwC,QAAQ,GAAG,CAAC,iBAAiB;AACvE,MAAM,aAAa,QAAQ,GAAG,CAAC,yBAAyB;AAExD,IAAI,CAAC,eAAe,CAAC,YAAY;IAC/B,MAAM,UAAU,EAAE;IAClB;;IACA,IAAI,CAAC,YAAY,QAAQ,IAAI,CAAC;IAC9B,MAAM,IAAI,MAAM,CAAC,4BAA4B,EAAE,QAAQ,IAAI,CAAC,OAAO;AACrE;AAEO,MAAM,gBAAgB,IAAA,gMAAY,EAAC,aAAa,YAAY;IACjE,MAAM;QAAE,gBAAgB;IAAM;AAChC"}},
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/HEALO_Demo/src/lib/intakeSchema.ts"],"sourcesContent":["/**\n * IntakeSchema — normalized_inquiries.constraints 고정 스키마\n * AI Agent(/api/chat) + Inquiry Form(/api/inquiry/normalize) 공통 적재용\n */\n\nexport type Intake = {\n  goal: string | null;\n  chief_complaint: string | null;\n  body_part: string | null;\n  duration: string | null;\n  severity: string | null;\n  budget: string | null;\n  timeline: string | null;\n  contraindications: string[] | null;\n  medical_history_flag: boolean | null;\n  medications_flag: boolean | null;\n  allergy_flag: boolean | null;\n  previous_procedure_flag: boolean | null;\n  attachments_present: boolean | null;\n};\n\nexport type IntakeMeta = {\n  pipeline_version: string;\n  source_type: \"ai_agent\" | \"inquiry_form\";\n  model: string | null;\n  prompt_version: string | null;\n};\n\n/** 필수 6개 — 누락 판단 기준 */\nconst REQUIRED_KEYS: (keyof Intake)[] = [\n  \"goal\",\n  \"chief_complaint\",\n  \"body_part\",\n  \"timeline\",\n  \"budget\",\n  \"attachments_present\",\n];\n\n/**\n * 빈 Intake + Meta 기본값\n */\nexport function createEmptyIntake(\n  source_type: \"ai_agent\" | \"inquiry_form\" = \"ai_agent\"\n): { intake: Intake; meta: IntakeMeta } {\n  const intake: Intake = {\n    goal: null,\n    chief_complaint: null,\n    body_part: null,\n    duration: null,\n    severity: null,\n    budget: null,\n    timeline: null,\n    contraindications: null,\n    medical_history_flag: null,\n    medications_flag: null,\n    allergy_flag: null,\n    previous_procedure_flag: null,\n    attachments_present: null,\n  };\n  const meta: IntakeMeta = {\n    pipeline_version: \"v1\",\n    source_type,\n    model: null,\n    prompt_version: null,\n  };\n  return { intake, meta };\n}\n\n/**\n * 누락 필드 목록 (필수 6개 기준)\n */\nexport function computeMissingFields(intake: Intake): string[] {\n  const missing: string[] = [];\n  for (const k of REQUIRED_KEYS) {\n    const v = intake[k];\n    if (k === \"attachments_present\") {\n      if (v === null || v === undefined) missing.push(k);\n      continue;\n    }\n    if (v === null || v === undefined || (typeof v === \"string\" && !String(v).trim())) {\n      missing.push(k);\n    }\n  }\n  return missing;\n}\n\n/**\n * 추출 신뢰도 0~1 (필수 6개 중 채워진 비율)\n */\nexport function computeExtractionConfidence(\n  intake: Intake,\n  missing_fields: string[]\n): number {\n  const filled = REQUIRED_KEYS.length - missing_fields.length;\n  if (filled <= 0) return 0;\n  return Math.min(1, Math.round((filled / REQUIRED_KEYS.length) * 100) / 100);\n}\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;;;;;AAyBD,qBAAqB,GACrB,MAAM,gBAAkC;IACtC;IACA;IACA;IACA;IACA;IACA;CACD;AAKM,SAAS,kBACd,cAA2C,UAAU;IAErD,MAAM,SAAiB;QACrB,MAAM;QACN,iBAAiB;QACjB,WAAW;QACX,UAAU;QACV,UAAU;QACV,QAAQ;QACR,UAAU;QACV,mBAAmB;QACnB,sBAAsB;QACtB,kBAAkB;QAClB,cAAc;QACd,yBAAyB;QACzB,qBAAqB;IACvB;IACA,MAAM,OAAmB;QACvB,kBAAkB;QAClB;QACA,OAAO;QACP,gBAAgB;IAClB;IACA,OAAO;QAAE;QAAQ;IAAK;AACxB;AAKO,SAAS,qBAAqB,MAAc;IACjD,MAAM,UAAoB,EAAE;IAC5B,KAAK,MAAM,KAAK,cAAe;QAC7B,MAAM,IAAI,MAAM,CAAC,EAAE;QACnB,IAAI,MAAM,uBAAuB;YAC/B,IAAI,MAAM,QAAQ,MAAM,WAAW,QAAQ,IAAI,CAAC;YAChD;QACF;QACA,IAAI,MAAM,QAAQ,MAAM,aAAc,OAAO,MAAM,YAAY,CAAC,OAAO,GAAG,IAAI,IAAK;YACjF,QAAQ,IAAI,CAAC;QACf;IACF;IACA,OAAO;AACT;AAKO,SAAS,4BACd,MAAc,EACd,cAAwB;IAExB,MAAM,SAAS,cAAc,MAAM,GAAG,eAAe,MAAM;IAC3D,IAAI,UAAU,GAAG,OAAO;IACxB,OAAO,KAAK,GAAG,CAAC,GAAG,KAAK,KAAK,CAAC,AAAC,SAAS,cAAc,MAAM,GAAI,OAAO;AACzE"}},
    {"offset": {"line": 127, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/HEALO_Demo/src/lib/intakeExtract.ts"],"sourcesContent":["/**\n * Intake 추출용 키워드/패턴 유틸 (normalize + chat 공용)\n */\n\nconst BODY_PART_KEYWORDS: [RegExp | string, string][] = [\n  [/nose|rhinoplasty|nasal/i, \"nose\"],\n  [/skin|acne|facial|laser|botox|filler/i, \"skin\"],\n  [/breast|augmentation|implants/i, \"breast\"],\n  [/hair|transplant|follicle/i, \"hair\"],\n  [/eye|lasik|eyelid|double eyelid/i, \"eye\"],\n  [/abdomen|tummy|liposuction|belly/i, \"abdomen\"],\n  [/chin|jaw/i, \"chin\"],\n  [/dental|implant|tooth|teeth/i, \"dental\"],\n];\n\nconst CONTRAINDICATION_KEYWORDS: [RegExp | string, string][] = [\n  [/allergy|allergic/i, \"allergy\"],\n  [/medication|medicine|meds|drug/i, \"medication\"],\n  [/diabetes|diabetic/i, \"diabetes\"],\n  [/pregnant|pregnancy/i, \"pregnant\"],\n];\n\nexport function bodyPartFromText(text: string | null | undefined): string | null {\n  const s = String(text || \"\").toLowerCase();\n  if (!s) return null;\n  for (const [pattern, part] of BODY_PART_KEYWORDS) {\n    if (typeof pattern === \"string\" ? s.includes(pattern) : pattern.test(s)) return part;\n  }\n  return null;\n}\n\nexport function contraindicationsAndFlagsFromMessage(\n  message: string | null | undefined\n): { contraindications: string[]; allergy: boolean; medications: boolean } {\n  const s = String(message || \"\").toLowerCase();\n  const contraindications: string[] = [];\n  let allergy = false;\n  let medications = false;\n  for (const [pattern, label] of CONTRAINDICATION_KEYWORDS) {\n    const match = typeof pattern === \"string\" ? s.includes(pattern) : pattern.test(s);\n    if (match) {\n      contraindications.push(label);\n      if (label === \"allergy\") allergy = true;\n      if (label === \"medication\") medications = true;\n    }\n  }\n  return { contraindications, allergy, medications };\n}\n\n/** query에서 timeline 추출 (asap, 1-3m, preferred_date 등) */\nexport function extractTimelineFromQuery(q: string): string | null {\n  const s = String(q || \"\").toLowerCase();\n  if (/\\basap\\b|as soon|urgent/i.test(s)) return \"asap\";\n  if (/1-3\\s*month|1\\s*to\\s*3\\s*m|within 3\\s*m/i.test(s)) return \"1-3m\";\n  if (/3-6\\s*month|3\\s*to\\s*6\\s*m/i.test(s)) return \"3-6m\";\n  if (/6\\s*month|6m\\+|6m\\s*plus/i.test(s)) return \"6m+\";\n  const iso = s.match(/\\b(20\\d{2})-(\\d{2})-(\\d{2})\\b/);\n  if (iso) return `preferred_date:${iso[0]}`;\n  const us = s.match(/\\b(\\d{1,2})\\/(\\d{1,2})\\/(\\d{4})\\b/);\n  if (us) return `preferred_date:${us[3]}-${us[1].padStart(2, \"0\")}-${us[2].padStart(2, \"0\")}`;\n  return null;\n}\n\n/** query에서 budget 추출 */\nexport function extractBudgetFromQuery(q: string): string | null {\n  const s = String(q || \"\").toLowerCase();\n  if (/\\bbudget\\b|price|cost|usd|won|\\$|₩|krw/i.test(s)) {\n    const m = s.match(/(\\d[\\d,.]*)\\s*(k|m|million|thousand)?\\s*(usd|won|krw|\\$|₩)?/i);\n    if (m) return m[0].trim().slice(0, 50);\n    return \"mentioned\";\n  }\n  return null;\n}\n\n/** query에서 duration 추출 (1w, 1m, 3m, 6m, 1y+) */\nexport function extractDurationFromQuery(q: string): string | null {\n  const s = String(q || \"\").toLowerCase();\n  if (/\\b1w\\b|1\\s*week/i.test(s)) return \"1w\";\n  if (/\\b1m\\b|1\\s*month/i.test(s)) return \"1m\";\n  if (/\\b3m\\b|3\\s*month/i.test(s)) return \"3m\";\n  if (/\\b6m\\b|6\\s*month/i.test(s)) return \"6m\";\n  if (/\\b1y\\b|1\\s*year|1y\\+/i.test(s)) return \"1y+\";\n  return null;\n}\n\n/** query에서 severity 추출 */\nexport function extractSeverityFromQuery(q: string): string | null {\n  const s = String(q || \"\").toLowerCase();\n  if (/\\bmild\\b|minor|slight/i.test(s)) return \"mild\";\n  if (/\\bmedium\\b|moderate/i.test(s)) return \"medium\";\n  if (/\\bsevere\\b|serious|bad/i.test(s)) return \"severe\";\n  const scale = s.match(/\\b([0-9]|10)\\s*\\/\\s*10\\b|\\b([0-9]|10)-10\\b/);\n  if (scale) return scale[0].slice(0, 20);\n  return null;\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 265, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/HEALO_Demo/app/api/chat/route.ts"],"sourcesContent":["import { streamText } from \"ai\";\nimport { openai } from \"@ai-sdk/openai\";\nimport { google } from \"@ai-sdk/google\";\nimport { supabaseAdmin } from \"../../../src/lib/rag/supabaseAdmin\";\nimport {\n  createEmptyIntake,\n  computeMissingFields,\n  computeExtractionConfidence,\n  type Intake,\n  type IntakeMeta,\n} from \"../../../src/lib/intakeSchema\";\nimport {\n  bodyPartFromText,\n  contraindicationsAndFlagsFromMessage,\n  extractTimelineFromQuery,\n  extractBudgetFromQuery,\n  extractDurationFromQuery,\n  extractSeverityFromQuery,\n} from \"../../../src/lib/intakeExtract\";\n\ntype ChatMessage = { role: string; content: string };\n\nconst isProd = process.env.NODE_ENV === \"production\";\nconst LLM_PROVIDER = (process.env.LLM_PROVIDER || \"openai\").toLowerCase();\n\nconst jsonError = (\n  status: number,\n  code: string,\n  detail?: string,\n  meta?: Record<string, any>\n) => {\n  return Response.json(\n    {\n      ok: false,\n      error: code,\n      ...(isProd ? {} : { detail, meta }),\n    },\n    { status }\n  );\n};\n\nconst getModel = () => {\n  if (LLM_PROVIDER === \"google\") {\n    if (!process.env.GOOGLE_GENERATIVE_AI_API_KEY) {\n      console.error(\"[api/chat] GOOGLE_GENERATIVE_AI_API_KEY is missing\");\n      return { error: jsonError(500, \"google_key_missing\", \"GOOGLE_GENERATIVE_AI_API_KEY is missing\") };\n    }\n    return { model: google(\"gemini-2.0-flash\") as any };\n  }\n  if (!process.env.OPENAI_API_KEY) {\n    console.error(\"[api/chat] OPENAI_API_KEY is missing\");\n    return { error: jsonError(500, \"openai_key_missing\", \"OPENAI_API_KEY is missing\") };\n  }\n  return { model: openai(\"gpt-4o-mini\") as any };\n};\n\nconst getModelName = () =>\n  LLM_PROVIDER === \"google\" ? \"gemini-2.0-flash\" : \"gpt-4o-mini\";\n\nconst classifyOpenAiError = (error: any) => {\n  const message = String(error?.message || \"\");\n  const lower = message.toLowerCase();\n\n  if (lower.includes(\"insufficient_quota\") || lower.includes(\"quota\")) {\n    return { status: 402, code: \"openai_quota_exceeded\", message };\n  }\n  if (lower.includes(\"invalid_api_key\") || lower.includes(\"api key\")) {\n    return { status: 401, code: \"openai_invalid_key\", message };\n  }\n  if (\n    lower.includes(\"model\") &&\n    (lower.includes(\"not found\") || lower.includes(\"does not exist\") || lower.includes(\"access\"))\n  ) {\n    return { status: 403, code: \"openai_model_access\", message };\n  }\n  if (lower.includes(\"rate limit\")) {\n    return { status: 429, code: \"openai_rate_limited\", message };\n  }\n  return { status: 502, code: \"openai_error\", message };\n};\n\nconst classifyGoogleError = (error: any) => {\n  const message = String(error?.message || \"\");\n  const lower = message.toLowerCase();\n\n  if (lower.includes(\"api key\")) {\n    return { status: 401, code: \"google_invalid_key\", message };\n  }\n  if (lower.includes(\"quota\") || lower.includes(\"insufficient\")) {\n    return { status: 402, code: \"google_quota_exceeded\", message };\n  }\n  if (lower.includes(\"permission\") || lower.includes(\"access\")) {\n    return { status: 403, code: \"google_access_denied\", message };\n  }\n  if (lower.includes(\"rate limit\")) {\n    return { status: 429, code: \"google_rate_limited\", message };\n  }\n  return { status: 502, code: \"google_error\", message };\n};\n\nconst buildContext = (chunks: Array<any>) => {\n  if (!Array.isArray(chunks) || chunks.length === 0) return \"\";\n  const lines = chunks.map((c) => {\n    const title = c?.rag_documents?.title ? ` | ${c.rag_documents.title}` : \"\";\n    const source = c?.rag_documents?.source_type\n      ? `[${c.rag_documents.source_type}${title}]`\n      : \"[source]\";\n    return `${source} ${String(c.content || \"\").trim()}`;\n  });\n  return lines.join(\"\\n\\n\");\n};\n\nconst getLastUserMessage = (messages: ChatMessage[] = []) => {\n  for (let i = messages.length - 1; i >= 0; i -= 1) {\n    if (messages[i]?.role === \"user\") return messages[i];\n  }\n  return null;\n};\n\nfunction buildIntakeFromQuery(query: string): Intake {\n  const { intake } = createEmptyIntake(\"ai_agent\");\n  try {\n    const q = String(query || \"\").trim();\n    intake.chief_complaint = q ? q.slice(0, 300) : null;\n    intake.goal = null;\n    intake.body_part = bodyPartFromText(q) ?? null;\n    intake.timeline = extractTimelineFromQuery(q) ?? null;\n    intake.budget = extractBudgetFromQuery(q) ?? null;\n    intake.duration = extractDurationFromQuery(q) ?? null;\n    intake.severity = extractSeverityFromQuery(q) ?? null;\n    const { contraindications, allergy, medications } = contraindicationsAndFlagsFromMessage(q);\n    intake.contraindications = contraindications.length ? contraindications : null;\n    intake.allergy_flag = allergy || null;\n    intake.medications_flag = medications || null;\n    intake.medical_history_flag = null;\n    intake.previous_procedure_flag = null;\n    intake.attachments_present = false;\n  } catch {\n    /* no-op */\n  }\n  return intake;\n}\n\nexport async function POST(request: Request) {\n  let body: any = {};\n  try {\n    body = await request.json();\n  } catch (error: any) {\n    console.error(\"[api/chat] invalid json:\", error);\n    return jsonError(400, \"invalid_json\", error?.message || \"invalid_json\");\n  }\n  const messages: ChatMessage[] = Array.isArray(body?.messages)\n    ? body.messages\n    : [];\n  const lang = body?.lang ? String(body.lang) : \"en\";\n  const sessionId = body?.session_id ? String(body.session_id) : null;\n  const page = body?.page ? String(body.page) : null;\n  const utm = body?.utm && typeof body.utm === \"object\" ? body.utm : null;\n  const lastUser = getLastUserMessage(messages);\n  const query = String(lastUser?.content || \"\").trim();\n\n  if (!query) {\n    return jsonError(400, \"user_message_required\", \"last user message is empty\");\n  }\n\n  // Log normalized inquiry (best effort). constraints.intake + meta 동일 스키마 적재.\n  void (async () => {\n    try {\n      let intake: Intake = buildIntakeFromQuery(query);\n      const meta: IntakeMeta = {\n        pipeline_version: \"v1\",\n        source_type: \"ai_agent\",\n        model: getModelName(),\n        prompt_version: null,\n      };\n      const missing_fields = computeMissingFields(intake);\n      const extraction_confidence = computeExtractionConfidence(intake, missing_fields);\n      const constraints: Record<string, unknown> = {\n        intake,\n        meta,\n      };\n      if (sessionId != null) constraints.session_id = sessionId;\n      if (page != null) constraints.page = page;\n      if (utm != null) constraints.utm = utm;\n\n      await supabaseAdmin.from(\"normalized_inquiries\").insert({\n        source_type: \"ai_agent\",\n        language: lang,\n        raw_message: query,\n        constraints,\n        treatment_slug: null,\n        objective: null,\n        extraction_confidence,\n        missing_fields: missing_fields.length ? missing_fields : null,\n      });\n    } catch (error) {\n      console.error(\"[api/chat] normalized_inquiries insert failed:\", error);\n    }\n  })();\n\n  // RAG retrieval (top 6).\n  let ragChunks: any[] = [];\n  try {\n    let q = supabaseAdmin\n      .from(\"rag_chunks\")\n      .select(\n        \"id, document_id, chunk_index, content, rag_documents!inner(id, source_type, source_id, lang, title)\"\n      )\n      .ilike(\"content\", `%${query}%`)\n      .limit(6);\n    if (lang) q = q.eq(\"rag_documents.lang\", lang);\n    const { data, error } = await q;\n    if (!error) ragChunks = data || [];\n    if (error) console.error(\"[api/chat] rag query error:\", error);\n  } catch (error) {\n    console.error(\"[api/chat] rag query failed:\", error);\n  }\n\n  const context = buildContext(ragChunks);\n\n  const systemPrompt = [\n    \"You are a medical concierge assistant for HEALO.\",\n    \"Do not provide diagnosis, medical advice, or guarantees.\",\n    \"Ask clarifying questions when constraints are missing.\",\n    \"Primary objective: guide the user to submit an inquiry.\",\n    \"If relevant, reference the provided context briefly.\",\n    \"\",\n    context ? \"Context:\\n\" + context : \"\",\n  ]\n    .filter(Boolean)\n    .join(\"\\n\");\n\n  const modelResult = getModel();\n  if (modelResult.error) return modelResult.error;\n\n  try {\n    const result = await streamText({\n      model: modelResult.model,\n      system: systemPrompt,\n      messages: messages as any,\n      onError: ({ error }) => {\n        console.error(\"[api/chat] stream error:\", error);\n      },\n    });\n    return result.toDataStreamResponse();\n  } catch (error: any) {\n    console.error(\"[api/chat] LLM error:\", error);\n    const classified =\n      LLM_PROVIDER === \"google\"\n        ? classifyGoogleError(error)\n        : classifyOpenAiError(error);\n    return jsonError(classified.status, classified.code, classified.message);\n  }\n}\n"],"names":[],"mappings":"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"}}]
}