{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 34, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/HEALO_Demo/src/lib/rag/supabaseAdmin.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\";\n\nconst supabaseUrl =\n  process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.VITE_SUPABASE_URL;\nconst serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\nif (!supabaseUrl || !serviceKey) {\n  const missing = [];\n  if (!supabaseUrl) missing.push(\"NEXT_PUBLIC_SUPABASE_URL/VITE_SUPABASE_URL\");\n  if (!serviceKey) missing.push(\"SUPABASE_SERVICE_ROLE_KEY\");\n  throw new Error(`Supabase admin env missing: ${missing.join(\", \")}`);\n}\n\nexport const supabaseAdmin = createClient(supabaseUrl, serviceKey, {\n  auth: { persistSession: false },\n});\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,cACJ,gFAAwC,QAAQ,GAAG,CAAC,iBAAiB;AACvE,MAAM,aAAa,QAAQ,GAAG,CAAC,yBAAyB;AAExD,IAAI,CAAC,eAAe,CAAC,YAAY;IAC/B,MAAM,UAAU,EAAE;IAClB;;IACA,IAAI,CAAC,YAAY,QAAQ,IAAI,CAAC;IAC9B,MAAM,IAAI,MAAM,CAAC,4BAA4B,EAAE,QAAQ,IAAI,CAAC,OAAO;AACrE;AAEO,MAAM,gBAAgB,IAAA,gMAAY,EAAC,aAAa,YAAY;IACjE,MAAM;QAAE,gBAAgB;IAAM;AAChC"}},
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/HEALO_Demo/app/api/inquiries/intake/route.ts"],"sourcesContent":["/**\n * HEALO: Step2 intake 저장 API (서버 전용)\n * inquiries.intake에 Step2 데이터 저장 (PII 없음)\n * public_token 검증 후 overwrite (MVP)\n */\n\nimport { supabaseAdmin } from \"../../../../src/lib/rag/supabaseAdmin\";\nimport { NextRequest } from \"next/server\";\n\nexport async function POST(request: NextRequest) {\n  try {\n    const body = await request.json().catch(() => ({}));\n    const inquiryId = body?.inquiryId != null\n      ? (typeof body.inquiryId === \"number\" ? body.inquiryId : Number(body.inquiryId))\n      : null;\n    const publicToken = body?.publicToken ? String(body.publicToken) : null;\n    const intakePatch = body?.intakePatch;\n\n    if (inquiryId == null || isNaN(inquiryId)) {\n      return Response.json(\n        { ok: false, error: \"inquiry_id_required\" },\n        { status: 400 }\n      );\n    }\n\n    if (!publicToken) {\n      return Response.json(\n        { ok: false, error: \"public_token_required\" },\n        { status: 400 }\n      );\n    }\n\n    if (!intakePatch || typeof intakePatch !== \"object\" || Array.isArray(intakePatch)) {\n      return Response.json(\n        { ok: false, error: \"intake_patch_must_be_object\" },\n        { status: 400 }\n      );\n    }\n\n    const { data: row, error: fetchErr } = await supabaseAdmin\n      .from(\"inquiries\")\n      .select(\"id, public_token, intake, attachments\")\n      .eq(\"id\", inquiryId)\n      .maybeSingle();\n\n    if (fetchErr) {\n      console.error(\"[api/inquiries/intake] fetch error:\", fetchErr);\n      return Response.json(\n        { ok: false, error: \"inquiry_fetch_failed\" },\n        { status: 500 }\n      );\n    }\n\n    if (!row) {\n      return Response.json(\n        { ok: false, error: \"inquiry_not_found\" },\n        { status: 404 }\n      );\n    }\n\n    const stored = row.public_token;\n    if (stored == null || String(stored) !== String(publicToken)) {\n      console.error(\"[api/inquiries/intake] public_token mismatch\");\n      return Response.json(\n        { ok: false, error: \"invalid_public_token\" },\n        { status: 403 }\n      );\n    }\n\n    const patch = { ...intakePatch } as Record<string, unknown>;\n    const extra = Array.isArray(patch.attachments_extra) ? (patch.attachments_extra as { path: string; name?: string | null; type?: string | null }[]) : [];\n    delete patch.attachments_extra;\n\n    const existingIntake = (row.intake && typeof row.intake === \"object\" && !Array.isArray(row.intake))\n      ? (row.intake as Record<string, unknown>)\n      : {};\n    const mergedIntake = { ...existingIntake, ...patch };\n\n    const existingAttachments = Array.isArray(row.attachments) ? row.attachments : [];\n    const mergedAttachments = [...existingAttachments, ...extra];\n\n    const updatePayload: Record<string, unknown> = { intake: mergedIntake };\n    if (extra.length) updatePayload.attachments = mergedAttachments;\n\n    const { error: updateErr } = await supabaseAdmin\n      .from(\"inquiries\")\n      .update(updatePayload)\n      .eq(\"id\", inquiryId);\n\n    if (updateErr) {\n      console.error(\"[api/inquiries/intake] update error:\", updateErr);\n      return Response.json(\n        { ok: false, error: \"intake_update_failed\" },\n        { status: 500 }\n      );\n    }\n\n    console.log(\"[api/inquiries/intake] success:\", { inquiryId });\n    return Response.json({ ok: true });\n  } catch (error: any) {\n    console.error(\"[api/inquiries/intake] error:\", error);\n    return Response.json(\n      { ok: false, error: error?.message || \"intake_failed\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}