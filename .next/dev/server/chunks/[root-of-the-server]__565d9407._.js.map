{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 34, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/HEALO_Demo/src/lib/rag/supabaseAdmin.ts"],"sourcesContent":["import { createClient } from \"@supabase/supabase-js\";\n\nconst supabaseUrl =\n  process.env.NEXT_PUBLIC_SUPABASE_URL || process.env.VITE_SUPABASE_URL;\nconst serviceKey = process.env.SUPABASE_SERVICE_ROLE_KEY;\n\nif (!supabaseUrl || !serviceKey) {\n  const missing = [];\n  if (!supabaseUrl) missing.push(\"NEXT_PUBLIC_SUPABASE_URL/VITE_SUPABASE_URL\");\n  if (!serviceKey) missing.push(\"SUPABASE_SERVICE_ROLE_KEY\");\n  throw new Error(`Supabase admin env missing: ${missing.join(\", \")}`);\n}\n\nexport const supabaseAdmin = createClient(supabaseUrl, serviceKey, {\n  auth: { persistSession: false },\n});\n"],"names":[],"mappings":";;;;AAAA;;AAEA,MAAM,cACJ,gFAAwC,QAAQ,GAAG,CAAC,iBAAiB;AACvE,MAAM,aAAa,QAAQ,GAAG,CAAC,yBAAyB;AAExD,IAAI,CAAC,eAAe,CAAC,YAAY;IAC/B,MAAM,UAAU,EAAE;IAClB;;IACA,IAAI,CAAC,YAAY,QAAQ,IAAI,CAAC;IAC9B,MAAM,IAAI,MAAM,CAAC,4BAA4B,EAAE,QAAQ,IAAI,CAAC,OAAO;AACrE;AAEO,MAAM,gBAAgB,IAAA,gMAAY,EAAC,aAAa,YAAY;IACjE,MAAM;QAAE,gBAAgB;IAAM;AAChC"}},
    {"offset": {"line": 58, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/HEALO_Demo/src/lib/intakeSchema.ts"],"sourcesContent":["/**\n * IntakeSchema — normalized_inquiries.constraints 고정 스키마\n * AI Agent(/api/chat) + Inquiry Form(/api/inquiry/normalize) 공통 적재용\n */\n\nexport type Intake = {\n  goal: string | null;\n  chief_complaint: string | null;\n  body_part: string | null;\n  duration: string | null;\n  severity: string | null;\n  budget: string | null;\n  timeline: string | null;\n  contraindications: string[] | null;\n  medical_history_flag: boolean | null;\n  medications_flag: boolean | null;\n  allergy_flag: boolean | null;\n  previous_procedure_flag: boolean | null;\n  attachments_present: boolean | null;\n};\n\nexport type IntakeMeta = {\n  pipeline_version: string;\n  source_type: \"ai_agent\" | \"inquiry_form\";\n  model: string | null;\n  prompt_version: string | null;\n};\n\n/** 필수 6개 — 누락 판단 기준 */\nconst REQUIRED_KEYS: (keyof Intake)[] = [\n  \"goal\",\n  \"chief_complaint\",\n  \"body_part\",\n  \"timeline\",\n  \"budget\",\n  \"attachments_present\",\n];\n\n/**\n * 빈 Intake + Meta 기본값\n */\nexport function createEmptyIntake(\n  source_type: \"ai_agent\" | \"inquiry_form\" = \"ai_agent\"\n): { intake: Intake; meta: IntakeMeta } {\n  const intake: Intake = {\n    goal: null,\n    chief_complaint: null,\n    body_part: null,\n    duration: null,\n    severity: null,\n    budget: null,\n    timeline: null,\n    contraindications: null,\n    medical_history_flag: null,\n    medications_flag: null,\n    allergy_flag: null,\n    previous_procedure_flag: null,\n    attachments_present: null,\n  };\n  const meta: IntakeMeta = {\n    pipeline_version: \"v1\",\n    source_type,\n    model: null,\n    prompt_version: null,\n  };\n  return { intake, meta };\n}\n\n/**\n * 누락 필드 목록 (필수 6개 기준)\n */\nexport function computeMissingFields(intake: Intake): string[] {\n  const missing: string[] = [];\n  for (const k of REQUIRED_KEYS) {\n    const v = intake[k];\n    if (k === \"attachments_present\") {\n      if (v === null || v === undefined) missing.push(k);\n      continue;\n    }\n    if (v === null || v === undefined || (typeof v === \"string\" && !String(v).trim())) {\n      missing.push(k);\n    }\n  }\n  return missing;\n}\n\n/**\n * 추출 신뢰도 0~1 (필수 6개 중 채워진 비율)\n */\nexport function computeExtractionConfidence(\n  intake: Intake,\n  missing_fields: string[]\n): number {\n  const filled = REQUIRED_KEYS.length - missing_fields.length;\n  if (filled <= 0) return 0;\n  return Math.min(1, Math.round((filled / REQUIRED_KEYS.length) * 100) / 100);\n}\n"],"names":[],"mappings":"AAAA;;;CAGC;;;;;;;;AAyBD,qBAAqB,GACrB,MAAM,gBAAkC;IACtC;IACA;IACA;IACA;IACA;IACA;CACD;AAKM,SAAS,kBACd,cAA2C,UAAU;IAErD,MAAM,SAAiB;QACrB,MAAM;QACN,iBAAiB;QACjB,WAAW;QACX,UAAU;QACV,UAAU;QACV,QAAQ;QACR,UAAU;QACV,mBAAmB;QACnB,sBAAsB;QACtB,kBAAkB;QAClB,cAAc;QACd,yBAAyB;QACzB,qBAAqB;IACvB;IACA,MAAM,OAAmB;QACvB,kBAAkB;QAClB;QACA,OAAO;QACP,gBAAgB;IAClB;IACA,OAAO;QAAE;QAAQ;IAAK;AACxB;AAKO,SAAS,qBAAqB,MAAc;IACjD,MAAM,UAAoB,EAAE;IAC5B,KAAK,MAAM,KAAK,cAAe;QAC7B,MAAM,IAAI,MAAM,CAAC,EAAE;QACnB,IAAI,MAAM,uBAAuB;YAC/B,IAAI,MAAM,QAAQ,MAAM,WAAW,QAAQ,IAAI,CAAC;YAChD;QACF;QACA,IAAI,MAAM,QAAQ,MAAM,aAAc,OAAO,MAAM,YAAY,CAAC,OAAO,GAAG,IAAI,IAAK;YACjF,QAAQ,IAAI,CAAC;QACf;IACF;IACA,OAAO;AACT;AAKO,SAAS,4BACd,MAAc,EACd,cAAwB;IAExB,MAAM,SAAS,cAAc,MAAM,GAAG,eAAe,MAAM;IAC3D,IAAI,UAAU,GAAG,OAAO;IACxB,OAAO,KAAK,GAAG,CAAC,GAAG,KAAK,KAAK,CAAC,AAAC,SAAS,cAAc,MAAM,GAAI,OAAO;AACzE"}},
    {"offset": {"line": 127, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/HEALO_Demo/src/lib/intakeExtract.ts"],"sourcesContent":["/**\n * Intake 추출용 키워드/패턴 유틸 (normalize + chat 공용)\n */\n\nconst BODY_PART_KEYWORDS: [RegExp | string, string][] = [\n  [/nose|rhinoplasty|nasal/i, \"nose\"],\n  [/skin|acne|facial|laser|botox|filler/i, \"skin\"],\n  [/breast|augmentation|implants/i, \"breast\"],\n  [/hair|transplant|follicle/i, \"hair\"],\n  [/eye|lasik|eyelid|double eyelid/i, \"eye\"],\n  [/abdomen|tummy|liposuction|belly/i, \"abdomen\"],\n  [/chin|jaw/i, \"chin\"],\n  [/dental|implant|tooth|teeth/i, \"dental\"],\n];\n\nconst CONTRAINDICATION_KEYWORDS: [RegExp | string, string][] = [\n  [/allergy|allergic/i, \"allergy\"],\n  [/medication|medicine|meds|drug/i, \"medication\"],\n  [/diabetes|diabetic/i, \"diabetes\"],\n  [/pregnant|pregnancy/i, \"pregnant\"],\n];\n\nexport function bodyPartFromText(text: string | null | undefined): string | null {\n  const s = String(text || \"\").toLowerCase();\n  if (!s) return null;\n  for (const [pattern, part] of BODY_PART_KEYWORDS) {\n    if (typeof pattern === \"string\" ? s.includes(pattern) : pattern.test(s)) return part;\n  }\n  return null;\n}\n\nexport function contraindicationsAndFlagsFromMessage(\n  message: string | null | undefined\n): { contraindications: string[]; allergy: boolean; medications: boolean } {\n  const s = String(message || \"\").toLowerCase();\n  const contraindications: string[] = [];\n  let allergy = false;\n  let medications = false;\n  for (const [pattern, label] of CONTRAINDICATION_KEYWORDS) {\n    const match = typeof pattern === \"string\" ? s.includes(pattern) : pattern.test(s);\n    if (match) {\n      contraindications.push(label);\n      if (label === \"allergy\") allergy = true;\n      if (label === \"medication\") medications = true;\n    }\n  }\n  return { contraindications, allergy, medications };\n}\n\n/** query에서 timeline 추출 (asap, 1-3m, preferred_date 등) */\nexport function extractTimelineFromQuery(q: string): string | null {\n  const s = String(q || \"\").toLowerCase();\n  if (/\\basap\\b|as soon|urgent/i.test(s)) return \"asap\";\n  if (/1-3\\s*month|1\\s*to\\s*3\\s*m|within 3\\s*m/i.test(s)) return \"1-3m\";\n  if (/3-6\\s*month|3\\s*to\\s*6\\s*m/i.test(s)) return \"3-6m\";\n  if (/6\\s*month|6m\\+|6m\\s*plus/i.test(s)) return \"6m+\";\n  const iso = s.match(/\\b(20\\d{2})-(\\d{2})-(\\d{2})\\b/);\n  if (iso) return `preferred_date:${iso[0]}`;\n  const us = s.match(/\\b(\\d{1,2})\\/(\\d{1,2})\\/(\\d{4})\\b/);\n  if (us) return `preferred_date:${us[3]}-${us[1].padStart(2, \"0\")}-${us[2].padStart(2, \"0\")}`;\n  return null;\n}\n\n/** query에서 budget 추출 */\nexport function extractBudgetFromQuery(q: string): string | null {\n  const s = String(q || \"\").toLowerCase();\n  if (/\\bbudget\\b|price|cost|usd|won|\\$|₩|krw/i.test(s)) {\n    const m = s.match(/(\\d[\\d,.]*)\\s*(k|m|million|thousand)?\\s*(usd|won|krw|\\$|₩)?/i);\n    if (m) return m[0].trim().slice(0, 50);\n    return \"mentioned\";\n  }\n  return null;\n}\n\n/** query에서 duration 추출 (1w, 1m, 3m, 6m, 1y+) */\nexport function extractDurationFromQuery(q: string): string | null {\n  const s = String(q || \"\").toLowerCase();\n  if (/\\b1w\\b|1\\s*week/i.test(s)) return \"1w\";\n  if (/\\b1m\\b|1\\s*month/i.test(s)) return \"1m\";\n  if (/\\b3m\\b|3\\s*month/i.test(s)) return \"3m\";\n  if (/\\b6m\\b|6\\s*month/i.test(s)) return \"6m\";\n  if (/\\b1y\\b|1\\s*year|1y\\+/i.test(s)) return \"1y+\";\n  return null;\n}\n\n/** query에서 severity 추출 */\nexport function extractSeverityFromQuery(q: string): string | null {\n  const s = String(q || \"\").toLowerCase();\n  if (/\\bmild\\b|minor|slight/i.test(s)) return \"mild\";\n  if (/\\bmedium\\b|moderate/i.test(s)) return \"medium\";\n  if (/\\bsevere\\b|serious|bad/i.test(s)) return \"severe\";\n  const scale = s.match(/\\b([0-9]|10)\\s*\\/\\s*10\\b|\\b([0-9]|10)-10\\b/);\n  if (scale) return scale[0].slice(0, 20);\n  return null;\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;;CAEC,GAED,MAAM,qBAAkD;IACtD;QAAC;QAA2B;KAAO;IACnC;QAAC;QAAwC;KAAO;IAChD;QAAC;QAAiC;KAAS;IAC3C;QAAC;QAA6B;KAAO;IACrC;QAAC;QAAmC;KAAM;IAC1C;QAAC;QAAoC;KAAU;IAC/C;QAAC;QAAa;KAAO;IACrB;QAAC;QAA+B;KAAS;CAC1C;AAED,MAAM,4BAAyD;IAC7D;QAAC;QAAqB;KAAU;IAChC;QAAC;QAAkC;KAAa;IAChD;QAAC;QAAsB;KAAW;IAClC;QAAC;QAAuB;KAAW;CACpC;AAEM,SAAS,iBAAiB,IAA+B;IAC9D,MAAM,IAAI,OAAO,QAAQ,IAAI,WAAW;IACxC,IAAI,CAAC,GAAG,OAAO;IACf,KAAK,MAAM,CAAC,SAAS,KAAK,IAAI,mBAAoB;QAChD,IAAI,OAAO,YAAY,WAAW,EAAE,QAAQ,CAAC,WAAW,QAAQ,IAAI,CAAC,IAAI,OAAO;IAClF;IACA,OAAO;AACT;AAEO,SAAS,qCACd,OAAkC;IAElC,MAAM,IAAI,OAAO,WAAW,IAAI,WAAW;IAC3C,MAAM,oBAA8B,EAAE;IACtC,IAAI,UAAU;IACd,IAAI,cAAc;IAClB,KAAK,MAAM,CAAC,SAAS,MAAM,IAAI,0BAA2B;QACxD,MAAM,QAAQ,OAAO,YAAY,WAAW,EAAE,QAAQ,CAAC,WAAW,QAAQ,IAAI,CAAC;QAC/E,IAAI,OAAO;YACT,kBAAkB,IAAI,CAAC;YACvB,IAAI,UAAU,WAAW,UAAU;YACnC,IAAI,UAAU,cAAc,cAAc;QAC5C;IACF;IACA,OAAO;QAAE;QAAmB;QAAS;IAAY;AACnD;AAGO,SAAS,yBAAyB,CAAS;IAChD,MAAM,IAAI,OAAO,KAAK,IAAI,WAAW;IACrC,IAAI,2BAA2B,IAAI,CAAC,IAAI,OAAO;IAC/C,IAAI,2CAA2C,IAAI,CAAC,IAAI,OAAO;IAC/D,IAAI,8BAA8B,IAAI,CAAC,IAAI,OAAO;IAClD,IAAI,4BAA4B,IAAI,CAAC,IAAI,OAAO;IAChD,MAAM,MAAM,EAAE,KAAK,CAAC;IACpB,IAAI,KAAK,OAAO,CAAC,eAAe,EAAE,GAAG,CAAC,EAAE,EAAE;IAC1C,MAAM,KAAK,EAAE,KAAK,CAAC;IACnB,IAAI,IAAI,OAAO,CAAC,eAAe,EAAE,EAAE,CAAC,EAAE,CAAC,CAAC,EAAE,EAAE,CAAC,EAAE,CAAC,QAAQ,CAAC,GAAG,KAAK,CAAC,EAAE,EAAE,CAAC,EAAE,CAAC,QAAQ,CAAC,GAAG,MAAM;IAC5F,OAAO;AACT;AAGO,SAAS,uBAAuB,CAAS;IAC9C,MAAM,IAAI,OAAO,KAAK,IAAI,WAAW;IACrC,IAAI,0CAA0C,IAAI,CAAC,IAAI;QACrD,MAAM,IAAI,EAAE,KAAK,CAAC;QAClB,IAAI,GAAG,OAAO,CAAC,CAAC,EAAE,CAAC,IAAI,GAAG,KAAK,CAAC,GAAG;QACnC,OAAO;IACT;IACA,OAAO;AACT;AAGO,SAAS,yBAAyB,CAAS;IAChD,MAAM,IAAI,OAAO,KAAK,IAAI,WAAW;IACrC,IAAI,mBAAmB,IAAI,CAAC,IAAI,OAAO;IACvC,IAAI,oBAAoB,IAAI,CAAC,IAAI,OAAO;IACxC,IAAI,oBAAoB,IAAI,CAAC,IAAI,OAAO;IACxC,IAAI,oBAAoB,IAAI,CAAC,IAAI,OAAO;IACxC,IAAI,wBAAwB,IAAI,CAAC,IAAI,OAAO;IAC5C,OAAO;AACT;AAGO,SAAS,yBAAyB,CAAS;IAChD,MAAM,IAAI,OAAO,KAAK,IAAI,WAAW;IACrC,IAAI,yBAAyB,IAAI,CAAC,IAAI,OAAO;IAC7C,IAAI,uBAAuB,IAAI,CAAC,IAAI,OAAO;IAC3C,IAAI,0BAA0B,IAAI,CAAC,IAAI,OAAO;IAC9C,MAAM,QAAQ,EAAE,KAAK,CAAC;IACtB,IAAI,OAAO,OAAO,KAAK,CAAC,EAAE,CAAC,KAAK,CAAC,GAAG;IACpC,OAAO;AACT"}},
    {"offset": {"line": 265, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/HEALO_Demo/src/lib/security/encryption.ts"],"sourcesContent":["/**\n * HEALO: 서버 사이드 암호화 유틸리티\n * pgcrypto 함수를 호출하여 데이터 암호화/복호화\n * 주의: 클라이언트에서는 사용하지 않음\n */\n\nimport { supabaseAdmin } from \"../rag/supabaseAdmin\";\n\nconst ENCRYPTION_KEY = process.env.SUPABASE_ENCRYPTION_KEY;\nconst MIN_KEY_LENGTH = 32;\n\n/**\n * 암호화 키 검증 (서버 부팅 시/암호화 호출 전에 실행)\n * 키가 없거나 길이가 부족하면 즉시 에러 발생\n * @throws Error 키 누락 또는 길이 부족 시\n */\nexport function assertEncryptionKey(): void {\n  if (!ENCRYPTION_KEY) {\n    const error = new Error(\n      \"[security/encryption] SUPABASE_ENCRYPTION_KEY is missing. \" +\n      \"암호화 키가 설정되지 않았습니다. 환경변수를 확인하세요. \" +\n      \"키 분실/변경 시 기존 데이터 복호화 불가.\"\n    );\n    console.error(error.message);\n    throw error;\n  }\n\n  if (ENCRYPTION_KEY.length < MIN_KEY_LENGTH) {\n    const error = new Error(\n      `[security/encryption] SUPABASE_ENCRYPTION_KEY is too short (${ENCRYPTION_KEY.length} < ${MIN_KEY_LENGTH}). ` +\n      `암호화 키는 최소 ${MIN_KEY_LENGTH}자 이상이어야 합니다. ` +\n      \"키 분실/변경 시 기존 데이터 복호화 불가.\"\n    );\n    console.error(error.message);\n    throw error;\n  }\n}\n\n// 서버 부팅 시 키 검증 (모듈 로드 시점)\n// 주의: 개발 환경에서는 경고만, 프로덕션에서는 즉시 실패\nif (process.env.NODE_ENV === \"production\") {\n  try {\n    assertEncryptionKey();\n  } catch (error) {\n    // 프로덕션에서는 즉시 종료\n    console.error(\"[security/encryption] FATAL: Encryption key validation failed on startup\");\n    process.exit(1);\n  }\n} else {\n  // 개발 환경에서는 경고만\n  if (!ENCRYPTION_KEY || ENCRYPTION_KEY.length < MIN_KEY_LENGTH) {\n    console.warn(\n      \"[security/encryption] WARNING: SUPABASE_ENCRYPTION_KEY is missing or too short. \" +\n      \"암호화 기능이 정상 작동하지 않을 수 있습니다.\"\n    );\n  }\n}\n\n/**\n * 텍스트 암호화 (서버에서만 사용)\n * @param plaintext 암호화할 텍스트\n * @returns base64 인코딩된 암호화 문자열 또는 null\n */\nexport async function encryptText(\n  plaintext: string | null | undefined\n): Promise<string | null> {\n  // 키 검증 (암호화 전에 수행)\n  assertEncryptionKey();\n\n  if (!plaintext) {\n    return null;\n  }\n\n  try {\n    const { data, error } = await supabaseAdmin.rpc(\"encrypt_text\", {\n      plaintext: String(plaintext),\n      encryption_key: ENCRYPTION_KEY,\n    });\n\n    if (error) {\n      console.error(\"[security/encryption] encrypt error:\", error);\n      return null;\n    }\n\n    return data as string | null;\n  } catch (error) {\n    console.error(\"[security/encryption] encrypt exception:\", error);\n    return null;\n  }\n}\n\n/**\n * 텍스트 복호화 (서버에서만 사용)\n * @param ciphertext base64 인코딩된 암호화 문자열\n * @returns 복호화된 텍스트 또는 null\n */\nexport async function decryptText(\n  ciphertext: string | null | undefined\n): Promise<string | null> {\n  // 키 검증 (복호화 전에 수행)\n  assertEncryptionKey();\n\n  if (!ciphertext) {\n    return null;\n  }\n\n  try {\n    const { data, error } = await supabaseAdmin.rpc(\"decrypt_text\", {\n      ciphertext: String(ciphertext),\n      encryption_key: ENCRYPTION_KEY,\n    });\n\n    if (error) {\n      console.error(\"[security/encryption] decrypt error:\", error);\n      return null;\n    }\n\n    return data as string | null;\n  } catch (error) {\n    console.error(\"[security/encryption] decrypt exception:\", error);\n    return null;\n  }\n}\n\n/**\n * Email 해시 생성 (검색용, 복호화 불가)\n * @param email 이메일 주소\n * @returns sha256 해시 (hex) 또는 null\n */\nexport async function hashEmail(\n  email: string | null | undefined\n): Promise<string | null> {\n  if (!email) {\n    return null;\n  }\n\n  try {\n    const { data, error } = await supabaseAdmin.rpc(\"email_hash\", {\n      email: String(email),\n    });\n\n    if (error) {\n      console.error(\"[security/encryption] hash error:\", error);\n      return null;\n    }\n\n    return data as string | null;\n  } catch (error) {\n    console.error(\"[security/encryption] hash exception:\", error);\n    return null;\n  }\n}\n"],"names":[],"mappings":";;;;;;;;;;AAAA;;;;CAIC,GAED;;AAEA,MAAM,iBAAiB,QAAQ,GAAG,CAAC,uBAAuB;AAC1D,MAAM,iBAAiB;AAOhB,SAAS;IACd,IAAI,CAAC,gBAAgB;QACnB,MAAM,QAAQ,IAAI,MAChB,+DACA,qCACA;QAEF,QAAQ,KAAK,CAAC,MAAM,OAAO;QAC3B,MAAM;IACR;IAEA,IAAI,eAAe,MAAM,GAAG,gBAAgB;QAC1C,MAAM,QAAQ,IAAI,MAChB,CAAC,4DAA4D,EAAE,eAAe,MAAM,CAAC,GAAG,EAAE,eAAe,GAAG,CAAC,GAC7G,CAAC,UAAU,EAAE,eAAe,aAAa,CAAC,GAC1C;QAEF,QAAQ,KAAK,CAAC,MAAM,OAAO;QAC3B,MAAM;IACR;AACF;AAEA,0BAA0B;AAC1B,kCAAkC;AAClC;;KAQO;IACL,eAAe;IACf,IAAI,CAAC,kBAAkB,eAAe,MAAM,GAAG,gBAAgB;QAC7D,QAAQ,IAAI,CACV,qFACA;IAEJ;AACF;AAOO,eAAe,YACpB,SAAoC;IAEpC,mBAAmB;IACnB;IAEA,IAAI,CAAC,WAAW;QACd,OAAO;IACT;IAEA,IAAI;QACF,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,qJAAa,CAAC,GAAG,CAAC,gBAAgB;YAC9D,WAAW,OAAO;YAClB,gBAAgB;QAClB;QAEA,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,wCAAwC;YACtD,OAAO;QACT;QAEA,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4CAA4C;QAC1D,OAAO;IACT;AACF;AAOO,eAAe,YACpB,UAAqC;IAErC,mBAAmB;IACnB;IAEA,IAAI,CAAC,YAAY;QACf,OAAO;IACT;IAEA,IAAI;QACF,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,qJAAa,CAAC,GAAG,CAAC,gBAAgB;YAC9D,YAAY,OAAO;YACnB,gBAAgB;QAClB;QAEA,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,wCAAwC;YACtD,OAAO;QACT;QAEA,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,4CAA4C;QAC1D,OAAO;IACT;AACF;AAOO,eAAe,UACpB,KAAgC;IAEhC,IAAI,CAAC,OAAO;QACV,OAAO;IACT;IAEA,IAAI;QACF,MAAM,EAAE,IAAI,EAAE,KAAK,EAAE,GAAG,MAAM,qJAAa,CAAC,GAAG,CAAC,cAAc;YAC5D,OAAO,OAAO;QAChB;QAEA,IAAI,OAAO;YACT,QAAQ,KAAK,CAAC,qCAAqC;YACnD,OAAO;QACT;QAEA,OAAO;IACT,EAAE,OAAO,OAAO;QACd,QAAQ,KAAK,CAAC,yCAAyC;QACvD,OAAO;IACT;AACF"}},
    {"offset": {"line": 369, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/user/Desktop/HEALO_Demo/app/api/inquiry/normalize/route.ts"],"sourcesContent":["import { supabaseAdmin } from \"../../../../src/lib/rag/supabaseAdmin\";\nimport {\n  createEmptyIntake,\n  type Intake,\n  type IntakeMeta,\n} from \"../../../../src/lib/intakeSchema\";\nimport {\n  bodyPartFromText,\n  contraindicationsAndFlagsFromMessage,\n} from \"../../../../src/lib/intakeExtract\";\nimport { encryptText, hashEmail } from \"../../../../src/lib/security/encryption\";\n\nconst detectLanguage = (value: string | null | undefined) => {\n  const v = String(value || \"\").toLowerCase();\n  if (v.includes(\"ko\") || v.includes(\"kr\") || v.includes(\"korean\")) return \"ko\";\n  if (v.includes(\"ja\") || v.includes(\"jp\") || v.includes(\"japanese\")) return \"ja\";\n  return \"en\";\n};\n\n/** Step2 intake → constraints.intake 표준 구조 (direct mapping) */\nfunction mapIntakeToConstraints(inq: { intake?: any; preferred_date?: string | null; preferred_date_flex?: boolean }): {\n  complaint: { body_part: string[] | null; duration: string | null; severity: number | null };\n  history: { diagnosis: { has: boolean; text: string } | null; meds: { has: boolean; text: string } | null };\n  logistics: { preferred_date: string | null; flex: boolean };\n} {\n  const i = inq?.intake && typeof inq.intake === \"object\" ? inq.intake : {};\n  const c = i?.complaint && typeof i.complaint === \"object\" ? i.complaint : {};\n  const h = i?.history && typeof i.history === \"object\" ? i.history : {};\n  const pref = inq?.preferred_date ? String(inq.preferred_date).slice(0, 10) : null;\n  const flex = !!inq?.preferred_date_flex;\n\n  const sev = typeof c.severity === \"number\" ? c.severity : (c.severity != null && c.severity !== \"\" ? Number(c.severity) : null);\n  return {\n    complaint: {\n      body_part: Array.isArray(c.body_part) ? c.body_part : (c.body_part ? [c.body_part] : null),\n      duration: (c.duration && typeof c.duration === \"string\") ? c.duration : null,\n      severity: sev != null && !Number.isNaN(sev) ? sev : null,\n    },\n    history: {\n      diagnosis: h.diagnosis && typeof h.diagnosis === \"object\"\n        ? { has: !!h.diagnosis.has, text: String(h.diagnosis.text || \"\") }\n        : null,\n      meds: h.meds && typeof h.meds === \"object\"\n        ? { has: !!h.meds.has, text: String(h.meds.text || \"\") }\n        : null,\n    },\n    logistics: {\n      preferred_date: pref,\n      flex,\n    },\n  };\n}\n\n/** 필수 충족 여부 기반 missing_fields (contact, nationality, spoken_language, treatment, preferred) */\nfunction computeRequiredMissing(row: {\n  email?: string | null;\n  contact_method?: string | null;\n  contact_id?: string | null;\n  nationality?: string | null;\n  spoken_language?: string | null;\n  treatment_type?: string | null;\n  preferred_date?: string | null;\n  preferred_date_flex?: boolean;\n}): string[] {\n  const missing: string[] = [];\n  const contactOk = !!(row?.email?.trim()) || !!(row?.contact_method && row?.contact_id?.trim());\n  if (!contactOk) missing.push(\"contact_reachable\");\n  if (!row?.nationality?.trim()) missing.push(\"nationality\");\n  if (!row?.spoken_language?.trim()) missing.push(\"spoken_language\");\n  if (!row?.treatment_type?.trim()) missing.push(\"treatment_type\");\n  const preferredOk = !!(row?.preferred_date?.trim()) || !!row?.preferred_date_flex;\n  if (!preferredOk) missing.push(\"preferred_date_or_flex\");\n  return missing;\n}\n\nfunction buildIntakeFromForm(row: {\n  message?: string | null;\n  treatment_type?: string | null;\n  preferred_date?: string | null;\n  attachment?: string | null;\n  attachments?: unknown;\n}): Intake {\n  const { intake } = createEmptyIntake(\"inquiry_form\");\n  try {\n    const msg = row?.message ?? null;\n    const tt = row?.treatment_type ?? null;\n    const pref = row?.preferred_date ?? null;\n    const att = row?.attachment ?? null;\n    const arr = Array.isArray(row?.attachments) ? row.attachments : [];\n    const hasAtt = !!att || arr.length > 0;\n\n    intake.chief_complaint = msg ? String(msg).trim().slice(0, 2000) : null;\n    intake.goal = tt ? String(tt) : (msg ? String(msg).trim().split(/\\n/)[0]?.slice(0, 300) || null : null);\n    intake.body_part = bodyPartFromText(tt || msg) ?? null;\n    intake.timeline = pref\n      ? `preferred_date:${String(pref).slice(0, 10)}`\n      : null;\n    intake.budget = null;\n    intake.duration = null;\n    intake.severity = null;\n\n    const { contraindications, allergy, medications } = contraindicationsAndFlagsFromMessage(msg);\n    intake.contraindications = contraindications.length ? contraindications : null;\n    intake.allergy_flag = allergy || null;\n    intake.medications_flag = medications || null;\n    intake.medical_history_flag = null;\n    intake.previous_procedure_flag = null;\n    intake.attachments_present = hasAtt;\n  } catch {\n    /* no-op: use empty intake */\n  }\n  return intake;\n}\n\nfunction buildIntakeFromTextOnly(text: string): Intake {\n  const { intake } = createEmptyIntake(\"ai_agent\");\n  try {\n    const s = String(text || \"\").trim().slice(0, 300);\n    intake.chief_complaint = s || null;\n    intake.goal = null;\n    intake.body_part = bodyPartFromText(text) ?? null;\n    intake.timeline = null;\n    intake.budget = null;\n    intake.duration = null;\n    intake.severity = null;\n    const { contraindications, allergy, medications } = contraindicationsAndFlagsFromMessage(text);\n    intake.contraindications = contraindications.length ? contraindications : null;\n    intake.allergy_flag = allergy || null;\n    intake.medications_flag = medications || null;\n    intake.medical_history_flag = null;\n    intake.previous_procedure_flag = null;\n    intake.attachments_present = false;\n  } catch {\n    /* no-op */\n  }\n  return intake;\n}\n\nexport async function POST(request: Request) {\n  try {\n    const body = await request.json().catch(() => ({}));\n    const text = body?.text ? String(body.text) : \"\";\n    const inquiryId = body?.inquiry_id != null ? Number(body.inquiry_id) : null;\n    const sourceTypePayload = body?.source_type === \"inquiry_form\" ? \"inquiry_form\" : null;\n    const sourceInquiryIdPayload = body?.source_inquiry_id != null ? Number(body.source_inquiry_id) : null;\n    const sessionId = body?.session_id != null ? String(body.session_id) : null;\n    const page = body?.page != null ? String(body.page) : null;\n    const utm = body?.utm && typeof body.utm === \"object\" ? body.utm : null;\n\n    const hasInquiryId = inquiryId != null || sourceInquiryIdPayload != null;\n    if (!text && !hasInquiryId) {\n      return Response.json(\n        { ok: false, error: \"text_or_inquiry_id_required\" },\n        { status: 400 }\n      );\n    }\n\n    if (sourceTypePayload === \"inquiry_form\" && !hasInquiryId) {\n      console.warn(\"[api/inquiry/normalize] inquiry_form requires inquiry_id / source_inquiry_id\");\n      return Response.json(\n        { ok: false, error: \"inquiry_id_required_for_inquiry_form\" },\n        { status: 400 }\n      );\n    }\n\n    const effectiveInquiryId = inquiryId ?? sourceInquiryIdPayload;\n\n    let inquiryRow: any = null;\n    if (effectiveInquiryId) {\n      const { data, error } = await supabaseAdmin\n        .from(\"inquiries\")\n        .select(\n          \"id, first_name, last_name, email, nationality, spoken_language, contact_method, contact_id, treatment_type, message, preferred_date, preferred_date_flex, attachment, attachments, intake\"\n        )\n        .eq(\"id\", effectiveInquiryId)\n        .single();\n      if (error) {\n        console.error(\"[api/inquiry/normalize] inquiries fetch error:\", error);\n        return Response.json(\n          { ok: false, error: error?.message || \"inquiry_fetch_failed\" },\n          { status: 500 }\n        );\n      }\n      inquiryRow = data;\n    }\n\n    const rawMessage = text || inquiryRow?.message || null;\n    const language = detectLanguage(inquiryRow?.spoken_language);\n    const sourceType = inquiryRow ? \"inquiry_form\" : \"ai_agent\";\n\n    const rawIntake = inquiryRow?.intake;\n    const hasIntake = rawIntake && typeof rawIntake === \"object\" && !Array.isArray(rawIntake) && Object.keys(rawIntake).length > 0;\n    const stepSource = hasIntake ? \"step2\" : \"step1\";\n\n    const constraintsIntake = hasIntake\n      ? mapIntakeToConstraints({\n          intake: inquiryRow.intake,\n          preferred_date: inquiryRow.preferred_date,\n          preferred_date_flex: inquiryRow.preferred_date_flex,\n        })\n      : (() => {\n          const legacy = buildIntakeFromForm(inquiryRow || {});\n          const pref = legacy.timeline?.startsWith(\"preferred_date:\")\n            ? String(legacy.timeline).replace(\"preferred_date:\", \"\").slice(0, 10)\n            : (inquiryRow?.preferred_date ? String(inquiryRow.preferred_date).slice(0, 10) : null);\n          return {\n            complaint: {\n              body_part: legacy.body_part ? [legacy.body_part] : null,\n              duration: legacy.duration ?? null,\n              severity: legacy.severity != null ? Number(legacy.severity) : null,\n            },\n            history: {\n              diagnosis: legacy.medical_history_flag != null ? { has: !!legacy.medical_history_flag, text: \"\" } : null,\n              meds: legacy.medications_flag != null ? { has: !!legacy.medications_flag, text: \"\" } : null,\n            },\n            logistics: {\n              preferred_date: pref,\n              flex: !!inquiryRow?.preferred_date_flex,\n            },\n          };\n        })();\n\n    const meta: IntakeMeta = {\n      pipeline_version: \"v1\",\n      source_type: sourceType,\n      model: null,\n      prompt_version: null,\n    };\n\n    const missing_fields = inquiryRow\n      ? computeRequiredMissing({\n          email: inquiryRow.email,\n          contact_method: inquiryRow.contact_method,\n          contact_id: inquiryRow.contact_id,\n          nationality: inquiryRow.nationality,\n          spoken_language: inquiryRow.spoken_language,\n          treatment_type: inquiryRow.treatment_type,\n          preferred_date: inquiryRow.preferred_date,\n          preferred_date_flex: inquiryRow.preferred_date_flex,\n        })\n      : [];\n    const requiredCount = 5;\n    const extraction_confidence = missing_fields.length < requiredCount\n      ? Math.min(1, Math.round((1 - missing_fields.length / requiredCount) * 100) / 100)\n      : 0;\n\n    const constraints: Record<string, unknown> = {\n      intake: constraintsIntake,\n      meta: { ...meta, source: stepSource } as any,\n    };\n    if (sessionId != null) constraints.session_id = sessionId;\n    if (page != null) constraints.page = page;\n    if (utm != null) constraints.utm = utm;\n\n    // ✅ Security: 민감 데이터 암호화\n    const rawMessageEnc = rawMessage ? await encryptText(rawMessage) : null;\n    const emailEnc = inquiryRow?.email ? await encryptText(inquiryRow.email) : null;\n    const contactIdEnc = inquiryRow?.contact_id ? await encryptText(inquiryRow.contact_id) : null;\n    const emailHash = inquiryRow?.email ? await hashEmail(inquiryRow.email) : null;\n\n    // 주의: raw_message는 암호화된 값 저장 (복호화는 서버에서만 가능)\n    // contact.email, contact.messenger_handle도 암호화된 값 저장\n    const { data: inserted, error: insertError } = await supabaseAdmin\n      .from(\"normalized_inquiries\")\n      .insert({\n        source_type: sourceType,\n        source_inquiry_id: inquiryRow ? inquiryRow.id : null,\n        language,\n        country: inquiryRow?.nationality ?? null,\n        treatment_slug: inquiryRow?.treatment_type ?? null,\n        objective: null,\n        constraints,\n        raw_message: rawMessageEnc, // 암호화된 값\n        extraction_confidence,\n        missing_fields: missing_fields.length ? missing_fields : null,\n        contact: inquiryRow\n          ? {\n              email: emailEnc, // 암호화된 값\n              email_hash: emailHash, // 검색용 해시\n              messenger_channel: inquiryRow.contact_method ?? null,\n              messenger_handle: contactIdEnc, // 암호화된 값\n            }\n          : null,\n      })\n      .select(\"*\")\n      .single();\n\n    if (insertError) {\n      console.error(\"[api/inquiry/normalize] normalized_inquiries insert failed:\", insertError);\n      return Response.json({ ok: true, normalized: null });\n    }\n\n    return Response.json({ ok: true, normalized: inserted });\n  } catch (error: any) {\n    console.error(\"[api/inquiry/normalize] error:\", error);\n    return Response.json(\n      { ok: false, error: error?.message || \"normalize_failed\" },\n      { status: 500 }\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}